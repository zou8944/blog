<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"zou8944.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.8.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"搜索...","empty":"没有找到任何搜索结果：${query}","hits_time":"找到 ${hits} 个搜索结果（用时 ${time} 毫秒）","hits":"找到 ${hits} 个搜索结果"}}</script><script src="/js/config.js"></script>
<meta name="description" content="Beat Jelly; Hit Jelly; Kill Jelly.">
<meta property="og:type" content="website">
<meta property="og:title" content="果冻 | Jelly">
<meta property="og:url" content="https://zou8944.com/page/3/index.html">
<meta property="og:site_name" content="果冻 | Jelly">
<meta property="og:description" content="Beat Jelly; Hit Jelly; Kill Jelly.">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="果冻 | Jelly">
<meta property="article:tag" content="果冻 博客">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="https://zou8944.com/page/3/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"zh-CN","comments":"","permalink":"","path":"page/3/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>果冻 | Jelly</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">果冻 | Jelly</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">果冻的碎碎念</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">果冻 | Jelly</p>
  <div class="site-description" itemprop="description">Beat Jelly; Hit Jelly; Kill Jelly.</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">78</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">26</span>
        <span class="site-state-item-name">分类</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">42</span>
        <span class="site-state-item-name">标签</span>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="返回顶部">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zou8944.com/Vertx%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%20-%20Web%EF%BC%88%E4%B8%8A%EF%BC%89-vertx-yuan-ma-jie-xi--web-shang-/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="果冻 | Jelly">
      <meta itemprop="description" content="Beat Jelly; Hit Jelly; Kill Jelly.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="果冻 | Jelly">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Vertx%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%20-%20Web%EF%BC%88%E4%B8%8A%EF%BC%89-vertx-yuan-ma-jie-xi--web-shang-/" class="post-title-link" itemprop="url">Vertx源码解析 - Web（上）</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-11-03 23:44:18" itemprop="dateCreated datePublished" datetime="2020-11-03T23:44:18+08:00">2020-11-03</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-02-16 23:44:32" itemprop="dateModified" datetime="2021-02-16T23:44:32+08:00">2021-02-16</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>我们在前面的文章分析了Vertx核心单机部分的源码。今天轮到<a target="_blank" rel="noopener" href="https://vertx-web-site.github.io/docs/vertx-web/java/">Vert.x-Web</a>，由于Web的内容比较多，因此分为上下两部分。</p>
<ul>
<li>上：分析Vert.x-Web核心类及其主要能力。</li>
<li>下：分析HttpServer的线程调度以及Web OpenAPI的工作原理</li>
</ul>
<p>一个基本的VertxWeb代码片段如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> vertx = Vertx.vertx()</span><br><span class="line">    <span class="keyword">val</span> router = Router.router(vertx)</span><br><span class="line">    router.<span class="keyword">get</span>(<span class="string">&quot;/hello&quot;</span>)</span><br><span class="line">        .handler &#123; ctx -&gt;</span><br><span class="line">                  println(<span class="string">&quot;哈哈哈，我好开心&quot;</span>)</span><br><span class="line">                  ctx.next()</span><br><span class="line">                 &#125;</span><br><span class="line">    .failureHandler(ErrorHandler.create())</span><br><span class="line">    <span class="keyword">val</span> server = vertx.createHttpServer().requestHandler(router)</span><br><span class="line">    server.listen(<span class="number">8080</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面创建了一个Http服务，暴露8080端口，并注册了一个path为hello，方法为GET的接口。上面涉及到Vert.x-Web的类有：Router、Route、RoutingContext、HttpServer。我们介绍前三个。</p>
<h2 id="Router"><a href="#Router" class="headerlink" title="Router"></a>Router</h2><h3 id="Router-1"><a href="#Router-1" class="headerlink" title="Router"></a>Router</h3><p>首先是Router接口，它主要有以下几个方面组成。</p>
<ul>
<li><p>Router.router(vertx) 创建一个Router对象</p>
</li>
<li><p>routeXXX() 各种路由方法，可以根据路径、方法、媒体类型、正则表达式等各种方式路由，返回一个Route对象，用于指定处理器。</p>
</li>
<li><p>getRoutes() 获取所有route</p>
</li>
<li><p>clear() 清除所有Route</p>
</li>
<li><p>mountSubRouter() 挂载子router</p>
</li>
<li><p>exceptionHandler() 指定一个router级别的异常处理器，当handler中抛出异常时，它会捕获。但它不会影响正常业务逻辑。</p>
<p>但它目前已被废弃，应该使用errorHandler()，它对应的是500的错误</p>
</li>
<li><p>errorHandler(code, handler)  当发生特定错误码时会调用它。当RoutingContext失败(fail) 或 一些handler失败但没有写响应 或 handler中抛出了异常，都会调用它。需要注意的是它的500有特殊的意义，代表通用错误。</p>
</li>
<li><p>handleContext(context) 将一个RoutingContext传进来，当一个Router被挂载到某个route时会用：将该route的RoutingContext传入本router进行处理。</p>
</li>
<li><p>handleFailure(RoutingContext) 使用场景同上，处理失败</p>
</li>
<li><p>modifiedHandler(handler) 当本Router的Route发生变化时该方法会被触发。</p>
</li>
</ul>
<p>首先说，Router只是Handler的子类，因此本质上还只是一个处理器，是被动调用的。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@VertxGen</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Router</span> <span class="keyword">extends</span> <span class="title">Handler</span>&lt;<span class="title">HttpServerRequest</span>&gt; </span>&#123;</span><br><span class="line">... ...</span><br></pre></td></tr></table></figure>

<h3 id="RouterImpl"><a href="#RouterImpl" class="headerlink" title="RouterImpl"></a>RouterImpl</h3><p>众多route生成方法的实现都大同小异，都是创建RouteImpl</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> synchronized Route route(String path) &#123;</span><br><span class="line">  state = state.incrementOrderSequence();</span><br><span class="line">  <span class="keyword">return</span> new RouteImpl(<span class="keyword">this</span>, state.getOrderSequence(), path);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>另外一个重点是handle，既然Router是Handler的子类，因此本类最初被调用的一定是handle方法（<strong>在请求进来时调用</strong>）</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> void handle(HttpServerRequest request) &#123;</span><br><span class="line">    <span class="comment">// 注意后面的next()调用，这很容易被看漏掉。</span></span><br><span class="line">    new RoutingContextImpl(<span class="literal">null</span>, <span class="keyword">this</span>, request, state.getRoutes()).next();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>啥也没干，就<strong>创建了一个RoutingContextImpl，并调用了next()，开启处理逻辑</strong>。</p>
<h3 id="RouterState"><a href="#RouterState" class="headerlink" title="RouterState"></a>RouterState</h3><p>一个RouterImpl包含一个RouterState，在初始化时创建，用于管理Router的状态</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> RouterImpl(Vertx vertx) &#123;</span><br><span class="line">    <span class="keyword">this</span>.vertx = vertx;</span><br><span class="line">    <span class="keyword">this</span>.state = new RouterState(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>共有如下几种状态</p>
<ul>
<li>Route集合：Router内注册的Route全在这里</li>
<li>errorHandler映射：失败的处理器，其中key对应的错误码，如400</li>
<li>modifiedHandler：用于在Router发生变化时做出响应的处理器</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Set&lt;RouteImpl&gt; routes;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Integer, Handler&lt;RoutingContext&gt;&gt; errorHandlers;</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Handler&lt;Router&gt; modifiedHandler;</span><br></pre></td></tr></table></figure>

<h2 id="Route"><a href="#Route" class="headerlink" title="Route"></a>Route</h2><h3 id="Route-1"><a href="#Route-1" class="headerlink" title="Route"></a>Route</h3><p>一个接口，对路由信息的描述，包含如下几种信息，见名思义。</p>
<ul>
<li>method</li>
<li>path</li>
<li>regex</li>
<li>consumes</li>
<li>produces</li>
</ul>
<p>同时包含了对匹配到的请求的处理方式</p>
<ul>
<li>handler()：为Route添加一个处理器，多个handler之间会连缀调用。</li>
<li>failureHandler()：为Route添加一个失败处理器，多个handler之间会连缀调用。</li>
<li>blockingHandler()：为Route添加一个能够执行阻塞操作的处理器。</li>
<li>subRouter()：为Route添加一个子Router，符合要求的请求都会被转发给该Router。</li>
</ul>
<h3 id="RouteImpl"><a href="#RouteImpl" class="headerlink" title="RouteImpl"></a>RouteImpl</h3><p>就是对上面各个方法的实现，这里不赘述。</p>
<h3 id="RouteState"><a href="#RouteState" class="headerlink" title="RouteState"></a>RouteState</h3><p>对一个路由状态的持有，相对RouterState而言，它持有的状态复杂得多。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 路径</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String path;</span><br><span class="line"><span class="comment">// 顺序</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> int order;</span><br><span class="line"><span class="comment">// 是否开启</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> boolean enabled;</span><br><span class="line"><span class="comment">// 方法</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Set&lt;HttpMethod&gt; methods;</span><br><span class="line"><span class="comment">// 消费的多媒体类型</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Set&lt;MIMEHeader&gt; consumes;</span><br><span class="line"><span class="comment">// 是否允许body为空</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> boolean emptyBodyPermittedWithConsumes;</span><br><span class="line"><span class="comment">// 产生的多媒体类型</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Set&lt;MIMEHeader&gt; produces;</span><br><span class="line"><span class="comment">// 常规处理器集合</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;Handler&lt;RoutingContext&gt;&gt; contextHandlers;</span><br><span class="line"><span class="comment">// 失败处理器集合</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;Handler&lt;RoutingContext&gt;&gt; failureHandlers;</span><br><span class="line"><span class="comment">// 不知道干嘛的</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> boolean added;</span><br><span class="line"><span class="comment">// 用于匹配的正则</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Pattern pattern;</span><br><span class="line"><span class="comment">// 也属于正则表达式的一部分</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;String&gt; groups;</span><br><span class="line"><span class="comment">// 是否使用归一化路径</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> boolean useNormalisedPath;</span><br><span class="line"><span class="comment">// 还是正则表达式</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Set&lt;String&gt; namedGroupsInRegex;</span><br><span class="line"><span class="comment">// 主机匹配</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Pattern virtualHostPattern;</span><br><span class="line"><span class="comment">// 路径是否以斜杠结尾</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> boolean pathEndsWithSlash;</span><br><span class="line"><span class="comment">// 是否被排除</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> boolean exclusive;</span><br><span class="line"><span class="comment">// 是否精确匹配</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> boolean exactPath;</span><br></pre></td></tr></table></figure>

<p>对Route最重要的方法当然是判断是否匹配，该方法也是在RouteState中给出</p>
<p>io.vertx.ext.web.impl.RouteState#matches，逻辑比较复杂，有兴趣可以去看看</p>
<h2 id="RoutingContext"><a href="#RoutingContext" class="headerlink" title="RoutingContext"></a>RoutingContext</h2><p>RoutingContext是Router上下文的抽象，代表一个请求从进入到响应全阶段的状态。由于在Router.handle()中，直接创建了RoutingContextImpl对象，并调用了RoutingContext.next()，因此我们重点关注它。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RoutingContext的实现类RoutingContextImpl的构造方法</span></span><br><span class="line"><span class="keyword">public</span> RoutingContextImpl(String mountPoint, RouterImpl router, HttpServerRequest request, Set&lt;RouteImpl&gt; routes) &#123;</span><br><span class="line">    <span class="keyword">super</span>(mountPoint, request, routes);</span><br><span class="line">    <span class="keyword">this</span>.router = router;</span><br><span class="line">    <span class="keyword">this</span>.fillParsedHeaders(request);</span><br><span class="line">    <span class="keyword">if</span> (request.path().length() == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.fail(<span class="number">400</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (request.path().charAt(<span class="number">0</span>) != <span class="string">&#x27;/&#x27;</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.fail(<span class="number">404</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// RoutingContextImpl的父类RoutingContextImplBase的构造方法</span></span><br><span class="line">RoutingContextImplBase(String mountPoint, HttpServerRequest request, Set&lt;RouteImpl&gt; routes) &#123;</span><br><span class="line">    <span class="keyword">this</span>.mountPoint = mountPoint;</span><br><span class="line">    <span class="keyword">this</span>.request = new HttpServerRequestWrapper(request);</span><br><span class="line">    <span class="keyword">this</span>.routes = routes;</span><br><span class="line">    <span class="keyword">this</span>.iter = routes.iterator();</span><br><span class="line">    <span class="keyword">this</span>.currentRouteNextHandlerIndex = new AtomicInteger(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">this</span>.currentRouteNextFailureHandlerIndex = new AtomicInteger(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">this</span>.resetMatchFailure();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// next方法</span></span><br><span class="line"><span class="keyword">public</span> void next() &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.iterateNext()) &#123;</span><br><span class="line">        <span class="keyword">this</span>.checkHandleNoMatch();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>仔细看iterateNext()</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">boolean iterateNext() &#123;</span><br><span class="line">    boolean failed = <span class="keyword">this</span>.failed();</span><br><span class="line">    <span class="comment">// 在route的第二个handler调用next时，走的是这段逻辑。</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.currentRoute != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!failed &amp;&amp; <span class="keyword">this</span>.currentRoute.hasNextContextHandler(<span class="keyword">this</span>)) &#123;</span><br><span class="line">                <span class="keyword">this</span>.currentRouteNextHandlerIndex.incrementAndGet();</span><br><span class="line">                <span class="keyword">this</span>.resetMatchFailure();</span><br><span class="line">                <span class="keyword">this</span>.currentRoute.handleContext(<span class="keyword">this</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (failed &amp;&amp; <span class="keyword">this</span>.currentRoute.hasNextFailureHandler(<span class="keyword">this</span>)) &#123;</span><br><span class="line">                <span class="keyword">this</span>.currentRouteNextFailureHandlerIndex.incrementAndGet();</span><br><span class="line">                <span class="keyword">this</span>.currentRoute.handleFailure(<span class="keyword">this</span>);</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable var5) &#123;</span><br><span class="line">            <span class="keyword">this</span>.handleInHandlerRuntimeFailure(<span class="keyword">this</span>.currentRoute.getRouter(), failed, var5);</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 死循环迭代所有route</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">        <span class="comment">// this.iter是Router.getRoutes().iterator()得到的，即迭代所有routes</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.iter.hasNext()) &#123;</span><br><span class="line">            <span class="comment">// RouteState包含了所有Route的状态和内容，因此要操作Route就一定要获取它啦</span></span><br><span class="line">            RouteState routeState = ((RouteImpl)<span class="keyword">this</span>.iter.next()).state();</span><br><span class="line">            <span class="keyword">this</span>.currentRouteNextHandlerIndex.<span class="keyword">set</span>(<span class="number">0</span>);</span><br><span class="line">            <span class="keyword">this</span>.currentRouteNextFailureHandlerIndex.<span class="keyword">set</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 匹配结果是0或4开头的状态码，如果是0则表示成功。这意味着每个route都会匹配一次，也一定会有一个结果。</span></span><br><span class="line">                int matchResult = routeState.matches(<span class="keyword">this</span>, <span class="keyword">this</span>.mountPoint(), failed);</span><br><span class="line">                <span class="comment">// 匹配失败的情况</span></span><br><span class="line">                <span class="keyword">if</span> (matchResult != <span class="number">0</span>) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (matchResult == <span class="number">405</span>) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (<span class="keyword">this</span>.matchFailure == <span class="number">404</span>) &#123;</span><br><span class="line">                            <span class="keyword">this</span>.matchFailure = matchResult;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (matchResult != <span class="number">404</span>) &#123;</span><br><span class="line">                        <span class="keyword">this</span>.matchFailure = matchResult;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 匹配成功的情况</span></span><br><span class="line">                <span class="keyword">this</span>.resetMatchFailure();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="keyword">this</span>.currentRoute = routeState;、</span><br><span class="line"></span><br><span class="line">                    <span class="keyword">if</span> (failed &amp;&amp; <span class="keyword">this</span>.currentRoute.hasNextFailureHandler(<span class="keyword">this</span>)) &#123;</span><br><span class="line">	                    <span class="comment">// 如果有失败，则调用route原先保存的failureHandler</span></span><br><span class="line">                        <span class="keyword">this</span>.currentRouteNextFailureHandlerIndex.incrementAndGet();</span><br><span class="line">                        routeState.handleFailure(<span class="keyword">this</span>);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// 如果成功，则调用route原先保存的contextHandler</span></span><br><span class="line">                        <span class="keyword">if</span> (!<span class="keyword">this</span>.currentRoute.hasNextContextHandler(<span class="keyword">this</span>)) &#123;</span><br><span class="line">                            <span class="keyword">continue</span>;</span><br><span class="line">                        &#125;</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">this</span>.currentRouteNextHandlerIndex.incrementAndGet();</span><br><span class="line">                        routeState.handleContext(<span class="keyword">this</span>);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable var6) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.handleInHandlerRuntimeFailure(routeState.getRouter(), failed, var6);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable var7) &#123;</span><br><span class="line">                <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">                    LOG.trace(<span class="string">&quot;IllegalArgumentException thrown during iteration&quot;</span>, var7);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (!<span class="keyword">this</span>.response().ended()) &#123;</span><br><span class="line">                    <span class="keyword">this</span>.unhandledFailure(var7 instanceof IllegalArgumentException ? <span class="number">400</span> : -<span class="number">1</span>, var7, routeState.getRouter());</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>再来仔细看</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> void checkHandleNoMatch() &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.failed()) &#123;</span><br><span class="line">	    <span class="comment">// 如果失败了，则按照未处理的异常处理，即从router的errorHandler中获取对应code的handler并给出结果</span></span><br><span class="line">        <span class="keyword">this</span>.unhandledFailure(<span class="keyword">this</span>.statusCode, <span class="keyword">this</span>.failure, <span class="keyword">this</span>.router);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 没有失败时也获取以下，有说明是预期的失败，还是要处理。</span></span><br><span class="line">        Handler&lt;RoutingContext&gt; handler = <span class="keyword">this</span>.router.getErrorHandlerByStatusCode(<span class="keyword">this</span>.matchFailure);</span><br><span class="line">        <span class="keyword">this</span>.statusCode = <span class="keyword">this</span>.matchFailure;</span><br><span class="line">        <span class="keyword">if</span> (handler == <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.response().setStatusCode(<span class="keyword">this</span>.matchFailure);</span><br><span class="line">            <span class="comment">// 404的情况</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span>.request().method() != HttpMethod.HEAD &amp;&amp; <span class="keyword">this</span>.matchFailure == <span class="number">404</span>) &#123;</span><br><span class="line">                <span class="keyword">this</span>.response().putHeader(HttpHeaderNames.CONTENT_TYPE, <span class="string">&quot;text/html; charset=utf-8&quot;</span>).end(<span class="string">&quot;&lt;html&gt;&lt;body&gt;&lt;h1&gt;Resource not found&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;&quot;</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 常规情况，直接结束</span></span><br><span class="line">                <span class="keyword">this</span>.response().end();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            handler.handle(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>到现在，抛开Router是被谁调用这问题。我们知道<strong>整个RoutingContext的执行起始是Router的handle方法：它创建RoutingContextImpl对象，并调用next()启动route的匹配操作，并在匹配后调用对应route的正常handler链或失败handler链。</strong></p>
<p>这里掌握三个关键点</p>
<ul>
<li><strong>RoutingContext对象是在Router的handle中创建的，并在匹配到的route的handler中流转。</strong></li>
<li><strong>遍历所有route的过程会在每次请求进来被处理。逻辑在iterateNext()方法的下半部分。</strong></li>
<li><strong>route的handler链调用比较特殊，需要开发者手动调用RoutingContext的next()方法处理。逻辑在iterateNext()方法的上半部分。</strong></li>
<li><strong>在从Router的handle开始，都是在当前线程不阻塞地执行，可以一镜到底。</strong></li>
</ul>
<p>对于Web的整个处理链，我们弄得差不多了。现在还存在如下问题，我们留待下篇再来看。</p>
<ul>
<li>谁构建HttpServerRequest并调用了Router的handler？</li>
<li>调用Router时线程分配是如何的？</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zou8944.com/Vert.x%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%20-%20Core-vertx-yuan-ma-jie-xi--core/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="果冻 | Jelly">
      <meta itemprop="description" content="Beat Jelly; Hit Jelly; Kill Jelly.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="果冻 | Jelly">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Vert.x%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90%20-%20Core-vertx-yuan-ma-jie-xi--core/" class="post-title-link" itemprop="url">Vert.x源码解析 - Core</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-10-03 23:43:22" itemprop="dateCreated datePublished" datetime="2020-10-03T23:43:22+08:00">2020-10-03</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-02-16 23:43:48" itemprop="dateModified" datetime="2021-02-16T23:43:48+08:00">2021-02-16</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Vert-x/" itemprop="url" rel="index"><span itemprop="name">Vert.x</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>希望通过本文的解析，让读者了解Vertx的关键部分的实现原理。对诸如如下问题有一个具象的认识。</p>
<ul>
<li>Vertx实例的作用？一个应用是否只对应一个Vertx实例？</li>
<li>Verticle是一个怎样的存在？</li>
<li>本地模式下消息是如何在EventBus上传输和响应的？</li>
<li>EventBus和EventLoop是如何关联起来的？</li>
</ul>
</blockquote>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>Vert.x是一个事件驱动，基于Netty库构建的高性能应用程序框架。实现了所谓的Multi-Reactor模型，能够充分利用多核CPU实现以事件循环为基础的基本编程模型。同时在此基础上构建了Verticle这样类似Actor的概念，以应对并发编程的需求。</p>
<p>Vert.x的核心为EventBus和EventLoop，前者用户消息传输，作为联通各个Handler的神经系统；后者作为任务执行的调度者，保证高性能。任何使用Vert.x构建的应用，都必须围绕这二者作文章。否则就失去了使用它的意义。</p>
<h2 id="核心类"><a href="#核心类" class="headerlink" title="核心类"></a><strong>核心类</strong></h2><h3 id="Vertx"><a href="#Vertx" class="headerlink" title="Vertx"></a>Vertx</h3><p>Vertx是最为核心的类，创建任何Vertx组件几乎都需要Vertx类的实例。</p>
<p>创建一个单机实例的方法是<code>Vertx.vertx()</code>，然后就可以使用了。以此为入口，我们看看Vertx在创建时都做了什么。</p>
<h4 id="看继承关系"><a href="#看继承关系" class="headerlink" title="看继承关系"></a>看继承关系</h4><p>Vertx是一个接口，VertxImpl是最终实现类，也是唯一的实现类。其中包含了单机和集群两种模式的实现。</p>
<p><img src="https://img-blog.csdnimg.cn/20201003110710869.png#pic_center" alt="在这里插入图片描述"></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 单机实现，创建返回VertxImpl即可</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> VertxImpl <span class="title">vertx</span><span class="params">(VertxOptions options, Transport transport)</span> </span>&#123;</span><br><span class="line">    VertxImpl vertx = <span class="keyword">new</span> VertxImpl(options, transport);</span><br><span class="line">    vertx.init();</span><br><span class="line">    <span class="keyword">return</span> vertx;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 集群实现，创建并加入集群</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">clusteredVertx</span><span class="params">(VertxOptions options, Transport transport, Handler&lt;AsyncResult&lt;Vertx&gt;&gt; resultHandler)</span> </span>&#123;</span><br><span class="line">    VertxImpl vertx = <span class="keyword">new</span> VertxImpl(options, transport);</span><br><span class="line">    vertx.joinCluster(options, resultHandler);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="看Vertx接口的功能"><a href="#看Vertx接口的功能" class="headerlink" title="看Vertx接口的功能"></a>看Vertx接口的功能</h4><p>从Vertx接口，看Vertx能干啥。图太长，不方便放，这里只列举核心部分，也是我们用得最多的。</p>
<ul>
<li>创建单机/集群版的Vertx实例</li>
<li>创建或获取上下文Context</li>
<li>指定特定的Handler运行在当前上下文中</li>
<li>获取EventBus</li>
<li>获取共享数据</li>
<li>设定定时任务</li>
<li>发布Verticle</li>
<li>执行阻塞方法</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/20201003110732393.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3pvdTg5NDQ=,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>如上，Vertx类几乎撑起了所有部分。接着我们看它是如何做到的。</p>
<h4 id="看VertxImpl构造方法"><a href="#看VertxImpl构造方法" class="headerlink" title="看VertxImpl构造方法"></a>看VertxImpl构造方法</h4><p>VertxImpl在构造时创建了很多私有对象，具体如下。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">VertxImpl</span><span class="params">(VertxOptions options, Transport transport)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 创建closeHooks，CloseHooks维护了一个Closeable的Set，可向其中添加、移除任务，还有执行所有钩子的run方法啦。</span></span><br><span class="line">    closeHooks = <span class="keyword">new</span> CloseHooks(log);</span><br><span class="line">    <span class="comment">// 创建线程阻塞检查器，它启动一个名为vertx-blocked-thread-checker的定时器，</span></span><br><span class="line">    checker = <span class="keyword">new</span> BlockedThreadChecker(options.getBlockedThreadCheckInterval(), options.getBlockedThreadCheckIntervalUnit(), options.getWarningExceptionTime(), options.getWarningExceptionTimeUnit());</span><br><span class="line">    <span class="comment">// 指定一个EventLoop最长可以连续执行多久</span></span><br><span class="line">    maxEventLoopExTime = options.getMaxEventLoopExecuteTime();</span><br><span class="line">    maxEventLoopExecTimeUnit = options.getMaxEventLoopExecuteTimeUnit();</span><br><span class="line">    <span class="comment">// 创建EventLoop线程工厂，主要用于指定线程名称和线程阻塞检测器</span></span><br><span class="line">    eventLoopThreadFactory = <span class="keyword">new</span> VertxThreadFactory(<span class="string">&quot;vert.x-eventloop-thread-&quot;</span>, checker, <span class="keyword">false</span>, maxEventLoopExTime, maxEventLoopExecTimeUnit);</span><br><span class="line">    <span class="comment">// 创建EventLoopGroup，它又实际创建了NioEventLoopGroup，它是Netty的组件。一个EventLoopGroup，就是一个EventLoop组。在Netty中，一个EventLoop是线程和IO的结合，一个EventLoop始终绑定在同一个线程上。</span></span><br><span class="line">    eventLoopGroup = transport.eventLoopGroup(Transport.IO_EVENT_LOOP_GROUP, options.getEventLoopPoolSize(), eventLoopThreadFactory, NETTY_IO_RATIO);</span><br><span class="line">    <span class="comment">// 创建一个acceptor EventLoopGroup，创建方式和上面类似。</span></span><br><span class="line">    ThreadFactory acceptorEventLoopThreadFactory = <span class="keyword">new</span> VertxThreadFactory(<span class="string">&quot;vert.x-acceptor-thread-&quot;</span>, checker, <span class="keyword">false</span>, options.getMaxEventLoopExecuteTime(), options.getMaxEventLoopExecuteTimeUnit());</span><br><span class="line">    acceptorEventLoopGroup = transport.eventLoopGroup(Transport.ACCEPTOR_EVENT_LOOP_GROUP, <span class="number">1</span>, acceptorEventLoopThreadFactory, <span class="number">100</span>);</span><br><span class="line">    <span class="comment">// 创建worker线程池</span></span><br><span class="line">    ExecutorService workerExec = <span class="keyword">new</span> ThreadPoolExecutor(workerPoolSize, workerPoolSize,</span><br><span class="line">                                                        <span class="number">0L</span>, TimeUnit.MILLISECONDS, <span class="keyword">new</span> LinkedTransferQueue&lt;&gt;(),</span><br><span class="line">                                                        <span class="keyword">new</span> VertxThreadFactory(<span class="string">&quot;vert.x-worker-thread-&quot;</span>, checker, <span class="keyword">true</span>, options.getMaxWorkerExecuteTime(), options.getMaxWorkerExecuteTimeUnit()));</span><br><span class="line">    PoolMetrics workerPoolMetrics = metrics != <span class="keyword">null</span> ? metrics.createPoolMetrics(<span class="string">&quot;worker&quot;</span>, <span class="string">&quot;vert.x-worker-thread&quot;</span>, 	options.getWorkerPoolSize()) : <span class="keyword">null</span>;</span><br><span class="line">    workerPool = <span class="keyword">new</span> WorkerPool(workerExec, workerPoolMetrics);</span><br><span class="line">    <span class="comment">// 创建inertnal阻塞线程池</span></span><br><span class="line">    ExecutorService internalBlockingExec = Executors.newFixedThreadPool(options.getInternalBlockingPoolSize(),</span><br><span class="line">                                                                        <span class="keyword">new</span> VertxThreadFactory(<span class="string">&quot;vert.x-internal-blocking-&quot;</span>, checker, <span class="keyword">true</span>, options.getMaxWorkerExecuteTime(), options.getMaxWorkerExecuteTimeUnit()));</span><br><span class="line">    internalBlockingPool = <span class="keyword">new</span> WorkerPool(internalBlockingExec, internalBlockingPoolMetrics);</span><br><span class="line">    <span class="comment">// 创建文件解析器，在FileSystem中有使用，进行文件操作时使用的是java nio</span></span><br><span class="line">    <span class="keyword">this</span>.fileResolver = <span class="keyword">new</span> FileResolver(options.getFileSystemOptions());</span><br><span class="line">    <span class="comment">// 创建地址解析器，在DNS解析时会用到</span></span><br><span class="line">    <span class="keyword">this</span>.addressResolver = <span class="keyword">new</span> AddressResolver(<span class="keyword">this</span>, options.getAddressResolverOptions());</span><br><span class="line">    <span class="comment">// 创建发布管理器，用于发布Verticle</span></span><br><span class="line">    <span class="keyword">this</span>.deploymentManager = <span class="keyword">new</span> DeploymentManager(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">if</span> (options.getEventBusOptions().isClustered()) &#123;</span><br><span class="line">        <span class="comment">// 创建集群管理器和集群的EventBus</span></span><br><span class="line">        <span class="keyword">this</span>.clusterManager = getClusterManager(options);</span><br><span class="line">        <span class="keyword">this</span>.eventBus = <span class="keyword">new</span> ClusteredEventBus(<span class="keyword">this</span>, options, clusterManager);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 创建本地EventBus</span></span><br><span class="line">        <span class="keyword">this</span>.clusterManager = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">this</span>.eventBus = <span class="keyword">new</span> EventBusImpl(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 创建sharedData，允许你在整个应用中共享你的数据，包括集群范围内</span></span><br><span class="line">    <span class="keyword">this</span>.sharedData = <span class="keyword">new</span> SharedDataImpl(<span class="keyword">this</span>, clusterManager);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面太复杂，整理成思维导图会好看很多。</p>
<p><img src="https://img-blog.csdnimg.cn/20201003110752755.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3pvdTg5NDQ=,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>EventBus用于进行消息传输；</p>
<p>EventLoopGroup为事件循环组，是Netty库中的类，每当有新的任务都会被提交到该组中执行；</p>
<p>而另一个EventLoopGroup——acceptorEventLoopGroup专用于网络服务的创建，目的是避免上面的eventLoopGroup的阻塞造成服务响应不及时；</p>
<p>WorkerPool为单独开的线程池，负责执行阻塞操作；</p>
<p>FileSystem用于操作文件；</p>
<p>AddressResolver用于进行DNS地址解析；</p>
<p>SharedData用于在整个Vertx应用内部共享数据，包括集群模式；</p>
<p>ClusterManager用于进行集群管理；</p>
<p>DeploymentManager和VerticleManager用于发布Verticle，保证Verticle的特性。</p>
<p>所有上述类你可能都不是很熟悉，没关系，先有个印象，下面分析具体场景时会用到。</p>
<h3 id="EventBus"><a href="#EventBus" class="headerlink" title="EventBus"></a>EventBus</h3><p>EventBus的继承关系也很简单，其单机版实现类为EventBusImpl，ClusteredEventBus继承自它，除了服务监听和远程调用，均使用了EventBusImpl中的方法。</p>
<p><img src="https://img-blog.csdnimg.cn/20201003110812514.png#pic_center" alt="在这里插入图片描述"></p>
<p>EventBus的能力，以及EventBusImpl持有对象如下：<br><img src="https://img-blog.csdnimg.cn/20201003110827811.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3pvdTg5NDQ=,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>出入拦截器自不必说，每次消息进来和出去都会先被拦截器处理；</p>
<p>vertx对象，主要用于获取发送调用代码所处的上线文环境；</p>
<p>handerMap是核心，以地址为key，地址上注册的Handler序列为value，存储了地址-处理器的映射管理；当触发发送动作时，就会到该映射中查找对应的处理器然后执行；对于单机应用，handlerMap就是所有；对于集群应用，则是先找到节点，再在节点中的handlerMap查找对应处理器。</p>
<p>sendNoContext是为了在执行发送的代码块不处于任何上下文时使用的上下文。EventBusImpl创建时使用。</p>
<p>EventBusImpl的构造方法没什么内容，就不提了。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">EventBusImpl</span><span class="params">(VertxInternal vertx)</span> </span>&#123;</span><br><span class="line">    VertxMetrics metrics = vertx.metricsSPI();</span><br><span class="line">    <span class="keyword">this</span>.vertx = vertx;</span><br><span class="line">    <span class="keyword">this</span>.metrics = metrics != <span class="keyword">null</span> ? metrics.createEventBusMetrics() : <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">this</span>.sendNoContext = vertx.getOrCreateContext();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="EventLoop"><a href="#EventLoop" class="headerlink" title="EventLoop"></a>EventLoop</h3><p>Vertx中并没有EventLoop这个类，它是Netty中的类。对Vertx的源码，与EventLoop相关的交互只有两处：创建EventLoopGroup；向EventLoopGroup提交任务。</p>
<p>具体内容请查找Netty相关资料进行学习。</p>
<h3 id="Context"><a href="#Context" class="headerlink" title="Context"></a>Context</h3><p>Context是真正提交任务的地方，凡Vertx中涉及到任务的执行，总是少不了Context的身影。<br><img src="https://img-blog.csdnimg.cn/20201003110844860.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3pvdTg5NDQ=,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>其核心能力主要在协调代码的运行，同时也可存储数据。其大部分逻辑都在ContextImpl中。其两个子类，仅在自我裁定、任务提交、上下文复制上有所不同。<br><img src="https://img-blog.csdnimg.cn/20201003110857360.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3pvdTg5NDQ=,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<h3 id="Verticle"><a href="#Verticle" class="headerlink" title="Verticle"></a>Verticle</h3><p>Verticle放在这里有一点另类，因为它并非核心组件。只是Vertx提供的actor模式实现的一个发布单元。它的actor特性由VerticleManager、EventBus、Context等一起保证。就其能力来说，也只有启动和停止两个方法。</p>
<p><img src="https://img-blog.csdnimg.cn/20201003110909141.png#pic_center" alt="在这里插入图片描述"></p>
<h2 id="从EventBus看Vertx工作原理"><a href="#从EventBus看Vertx工作原理" class="headerlink" title="从EventBus看Vertx工作原理"></a>从EventBus看Vertx工作原理</h2><p>一个简单的Vertx应用如下，我们从它开始分析。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">val</span> vertx = Vertx.vertx();</span><br><span class="line">  vertx.eventBus().consumer&lt;String&gt;(<span class="string">&quot;helloAddress&quot;</span>).handler&#123;</span><br><span class="line">    print(it.body())</span><br><span class="line">  &#125;</span><br><span class="line">  vertx.eventBus().send(<span class="string">&quot;helloAddress&quot;</span>, <span class="string">&quot;hello world!&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Vertx.vertx()在上面已经看过了，它创建了一个VertxImpl对象，持有一堆用于组织工作的属性，包括EventBus。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// vertx实例时对eventBus赋值的快照</span></span><br><span class="line"><span class="keyword">this</span>.eventBus = <span class="keyword">new</span> EventBusImpl(<span class="keyword">this</span>);</span><br></pre></td></tr></table></figure>

<h3 id="consumer做了什么"><a href="#consumer做了什么" class="headerlink" title="consumer做了什么"></a>consumer做了什么</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">MessageConsumer&lt;T&gt; <span class="title">consumer</span><span class="params">(String address, Handler&lt;Message&lt;T&gt;&gt; handler)</span> </span>&#123;</span><br><span class="line">    Objects.requireNonNull(handler, <span class="string">&quot;handler&quot;</span>);</span><br><span class="line">    MessageConsumer&lt;T&gt; consumer = consumer(address);</span><br><span class="line">    consumer.handler(handler);</span><br><span class="line">    <span class="keyword">return</span> consumer;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 往里进一步</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">MessageConsumer&lt;T&gt; <span class="title">consumer</span><span class="params">(String address)</span> </span>&#123;</span><br><span class="line">    checkStarted();</span><br><span class="line">    Objects.requireNonNull(address, <span class="string">&quot;address&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> HandlerRegistration&lt;&gt;(vertx, metrics, <span class="keyword">this</span>, address, <span class="keyword">null</span>, <span class="keyword">false</span>, <span class="keyword">null</span>, -<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 重点在HandlerRegistration，收集地址后，开启超时回复定时器。</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HandlerRegistration</span><span class="params">(Vertx vertx, EventBusMetrics metrics, EventBusImpl eventBus, String address,</span></span></span><br><span class="line"><span class="params"><span class="function">                               String repliedAddress, <span class="keyword">boolean</span> localOnly,</span></span></span><br><span class="line"><span class="params"><span class="function">                               Handler&lt;AsyncResult&lt;Message&lt;T&gt;&gt;&gt; asyncResultHandler, <span class="keyword">long</span> timeout)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.vertx = vertx;</span><br><span class="line">    <span class="keyword">this</span>.metrics = metrics;</span><br><span class="line">    <span class="keyword">this</span>.eventBus = eventBus;</span><br><span class="line">    <span class="keyword">this</span>.address = address;</span><br><span class="line">    <span class="keyword">this</span>.repliedAddress = repliedAddress;</span><br><span class="line">    <span class="keyword">this</span>.localOnly = localOnly;</span><br><span class="line">    <span class="keyword">this</span>.asyncResultHandler = asyncResultHandler;</span><br><span class="line">    <span class="keyword">if</span> (timeout != -<span class="number">1</span>) &#123;</span><br><span class="line">        timeoutID = vertx.setTimer(timeout, tid -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (metrics != <span class="keyword">null</span>) &#123;</span><br><span class="line">                metrics.replyFailure(address, ReplyFailure.TIMEOUT);</span><br><span class="line">            &#125;</span><br><span class="line">            sendAsyncResultFailure(<span class="keyword">new</span> ReplyException(ReplyFailure.TIMEOUT, <span class="string">&quot;Timed out after waiting &quot;</span> + timeout + <span class="string">&quot;(ms) for a reply. address: &quot;</span> + address + <span class="string">&quot;, repliedAddress: &quot;</span> + repliedAddress));</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 最上面的consumer.handler(handler);调用了HandlerRegistration的handler方法，如下。可以看到最终是在eventBus上调用了注册方法。</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> MessageConsumer&lt;T&gt; <span class="title">handler</span><span class="params">(Handler&lt;Message&lt;T&gt;&gt; h)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (h != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">            handler = h;</span><br><span class="line">            <span class="keyword">if</span> (registered == <span class="keyword">null</span>) &#123;</span><br><span class="line">                registered = eventBus.addRegistration(address, <span class="keyword">this</span>, repliedAddress != <span class="keyword">null</span>, localOnly);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.unregister();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 最终来到了EventBus的addRegistration方法。在addLocalRegistration中，创建了HandlerHolder，并将其加入EventBus的成员变量handlerMap，然后返回创建的HandlerHolder</span></span><br><span class="line"><span class="keyword">protected</span> &lt;T&gt; <span class="function">HandlerHolder&lt;T&gt; <span class="title">addRegistration</span><span class="params">(String address, HandlerRegistration&lt;T&gt; registration,</span></span></span><br><span class="line"><span class="params"><span class="function">                                               <span class="keyword">boolean</span> replyHandler, <span class="keyword">boolean</span> localOnly)</span> </span>&#123;</span><br><span class="line">    Objects.requireNonNull(registration.getHandler(), <span class="string">&quot;handler&quot;</span>);</span><br><span class="line">    LocalRegistrationResult&lt;T&gt; result = addLocalRegistration(address, registration, replyHandler, localOnly);</span><br><span class="line">    addRegistration(result.newAddress, address, replyHandler, localOnly, registration::setResult);</span><br><span class="line">    <span class="keyword">return</span> result.holder;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>要点总结</p>
<ul>
<li>consumer方法仅仅将给定的handler注册到EventBusImpl持有的handlerMap中，等待被消费。</li>
</ul>
<h3 id="send做了什么"><a href="#send做了什么" class="headerlink" title="send做了什么"></a>send做了什么</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//通过跟踪，最终会来到sendOrPubInternal，首先创建一个用于回复的HandlerRegistration，然后创建OutboundDeliveryContext，调用其next方法</span></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">sendOrPubInternal</span><span class="params">(MessageImpl message, DeliveryOptions options,</span></span></span><br><span class="line"><span class="params"><span class="function">                                  Handler&lt;AsyncResult&lt;Message&lt;T&gt;&gt;&gt; replyHandler)</span> </span>&#123;</span><br><span class="line">    checkStarted();</span><br><span class="line">    HandlerRegistration&lt;T&gt; replyHandlerRegistration = createReplyHandlerRegistration(message, options, replyHandler);</span><br><span class="line">    OutboundDeliveryContext&lt;T&gt; sendContext = <span class="keyword">new</span> OutboundDeliveryContext&lt;&gt;(message, options, replyHandlerRegistration);</span><br><span class="line">    sendContext.next();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// createReplyHandlerRegistration方法创建了__vertx.reply.xxx地址的响应HandlerRegistration</span></span><br><span class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function">HandlerRegistration&lt;T&gt; <span class="title">createReplyHandlerRegistration</span><span class="params">(MessageImpl message,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                                  DeliveryOptions options,</span></span></span><br><span class="line"><span class="params"><span class="function">                                                                  Handler&lt;AsyncResult&lt;Message&lt;T&gt;&gt;&gt; replyHandler)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (replyHandler != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">long</span> timeout = options.getSendTimeout();</span><br><span class="line">        String replyAddress = generateReplyAddress();</span><br><span class="line">        message.setReplyAddress(replyAddress);</span><br><span class="line">        Handler&lt;Message&lt;T&gt;&gt; simpleReplyHandler = convertHandler(replyHandler);</span><br><span class="line">        HandlerRegistration&lt;T&gt; registration =</span><br><span class="line">            <span class="keyword">new</span> HandlerRegistration&lt;&gt;(vertx, metrics, <span class="keyword">this</span>, replyAddress, message.address, <span class="keyword">true</span>, replyHandler, timeout);</span><br><span class="line">        registration.handler(simpleReplyHandler);</span><br><span class="line">        <span class="keyword">return</span> registration;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">protected</span> String <span class="title">generateReplyAddress</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;__vertx.reply.&quot;</span> + Long.toString(replySequence.incrementAndGet());</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// OutboundDeliveryContext类接收了消息和响应HandlerRegistration，调用next，如下。其中的iter多半是拦截器，暂时不用管。核心在sendOrPub(this)和sendReply(this, replierMessage)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (iter.hasNext()) &#123;</span><br><span class="line">        Handler&lt;DeliveryContext&gt; handler = iter.next();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (handler != <span class="keyword">null</span>) &#123;</span><br><span class="line">                handler.handle(<span class="keyword">this</span>);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                next();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            log.error(<span class="string">&quot;Failure in interceptor&quot;</span>, t);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (replierMessage == <span class="keyword">null</span>) &#123;</span><br><span class="line">            sendOrPub(<span class="keyword">this</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            sendReply(<span class="keyword">this</span>, replierMessage);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 定义io.vertx.core.eventbus.impl.EventBusImpl#sendOrPub，再定位到io.vertx.core.eventbus.impl.EventBusImpl#deliverMessageLocally,最终来到io.vertx.core.eventbus.impl.EventBusImpl#deliverMessageLocally</span></span><br><span class="line"><span class="comment">// 这里的关键由两个地方：一是点对点的实现——再handlerMap中找到指定地址的handlers，只取第一个进行处理；还有发布订阅的实现——对在一个地址注册的handlers全部处理；第二个关键点是消息发送的方法deliverToHandler(msg, holder)</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> ReplyException <span class="title">deliverMessageLocally</span><span class="params">(MessageImpl msg)</span> </span>&#123;</span><br><span class="line">    msg.setBus(<span class="keyword">this</span>);</span><br><span class="line">    ConcurrentCyclicSequence&lt;HandlerHolder&gt; handlers = handlerMap.get(msg.address());</span><br><span class="line">    <span class="keyword">if</span> (handlers != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (msg.isSend()) &#123;</span><br><span class="line">            <span class="comment">//Choose one</span></span><br><span class="line">            HandlerHolder holder = handlers.next();</span><br><span class="line">            <span class="keyword">if</span> (metrics != <span class="keyword">null</span>) &#123;</span><br><span class="line">                metrics.messageReceived(msg.address(), !msg.isSend(), isMessageLocal(msg), holder != <span class="keyword">null</span> ? <span class="number">1</span> : <span class="number">0</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (holder != <span class="keyword">null</span>) &#123;</span><br><span class="line">                deliverToHandler(msg, holder);</span><br><span class="line">                Handler&lt;AsyncResult&lt;Void&gt;&gt; handler = msg.writeHandler;</span><br><span class="line">                <span class="keyword">if</span> (handler != <span class="keyword">null</span>) &#123;</span><br><span class="line">                    handler.handle(Future.succeededFuture());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Publish</span></span><br><span class="line">            <span class="keyword">if</span> (metrics != <span class="keyword">null</span>) &#123;</span><br><span class="line">                metrics.messageReceived(msg.address(), !msg.isSend(), isMessageLocal(msg), handlers.size());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">for</span> (HandlerHolder holder: handlers) &#123;</span><br><span class="line">                deliverToHandler(msg, holder);</span><br><span class="line">            &#125;</span><br><span class="line">            Handler&lt;AsyncResult&lt;Void&gt;&gt; handler = msg.writeHandler;</span><br><span class="line">            <span class="keyword">if</span> (handler != <span class="keyword">null</span>) &#123;</span><br><span class="line">                handler.handle(Future.succeededFuture());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ... ...</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 最终的处理函数如下：创建InboundDeliveryContext，在HandlerHolder的context环境下运行其next方法：</span></span><br><span class="line"><span class="keyword">private</span> &lt;T&gt; <span class="function"><span class="keyword">void</span> <span class="title">deliverToHandler</span><span class="params">(MessageImpl msg, HandlerHolder&lt;T&gt; holder)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Each handler gets a fresh copy</span></span><br><span class="line">    MessageImpl copied = msg.copyBeforeReceive();</span><br><span class="line">    DeliveryContext&lt;T&gt; receiveContext = <span class="keyword">new</span> InboundDeliveryContext&lt;&gt;(copied, holder);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (metrics != <span class="keyword">null</span>) &#123;</span><br><span class="line">        metrics.scheduleMessage(holder.getHandler().getMetric(), msg.isLocal());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    holder.getContext().runOnContext((v) -&gt; &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            receiveContext.next();</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (holder.isReplyHandler()) &#123;</span><br><span class="line">                holder.getHandler().unregister();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// next方法啥也没干，直接将message传入目标handler</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (iter.hasNext()) &#123;</span><br><span class="line">        <span class="comment">// ... 拦截器迭代，忽略</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        holder.getHandler().handle(message);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>要点总结</p>
<ul>
<li>send分为两步<ul>
<li>查询handler，调用send时马上执行，是同步的。</li>
<li>执行handler，通过handler注册时的context执行，是异步的。</li>
</ul>
</li>
<li>消息响应的实现方式是注册一个响应handler到EventBus中，名为__vertx.reply.xxx，其中xxx为单调递增数字。</li>
<li>如果同一地址注册了多个handler，则点对点传输模式下只会取第一个handler进行处理；发布模式下才会执行所有。</li>
<li>在一个上下文中注册的handler，不管被执行时机如何，最终都会在该上下文中执行。参见：<code>holder.getContext().runOnContext(...</code>，hodler为HandlerHolder对象，在调用consumer注册时保存了注册上下文。</li>
</ul>
<h3 id="和EventLoop的关系在哪？"><a href="#和EventLoop的关系在哪？" class="headerlink" title="和EventLoop的关系在哪？"></a>和EventLoop的关系在哪？</h3><p>通过consumer和send看到了EventBus是如何协调接收和发送的，但并没有看到EventLoop是如何参与的。其实它是有参与的，在<code>holder.getContext().runOnContext(...</code>是进行了参与。</p>
<p>于是我们看看EventLoopContext.runOnContext()，如下。就是向Context保存的EventLoop对象提交一个任务即可。调度的事，交给Netty来做</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 看到只调用了一个executeAsync()</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">runOnContext</span><span class="params">(Handler&lt;Void&gt; task)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        executeAsync(task);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RejectedExecutionException ignore) &#123;</span><br><span class="line">        <span class="comment">// Pool is already shut down</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// 这里就能看到Vertx的底了，它直接将任务提交给了netty的eventLoop</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">executeAsync</span><span class="params">(Handler&lt;Void&gt; task)</span> </span>&#123;</span><br><span class="line">    nettyEventLoop().execute(() -&gt; executeTask(<span class="keyword">null</span>, task));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Verticle工作机制"><a href="#Verticle工作机制" class="headerlink" title="Verticle工作机制"></a>Verticle工作机制</h2><p>Vert.x推荐使用Verticle进行开发，它是一个类Actor的模型，具有如下特点。</p>
<ul>
<li>同一Verticle下的所有操作均在一个EventLoop线程上执行。以此避免了线程安全问题。</li>
<li>Verticle之间通过EventBus进行消息传递</li>
<li>Verticle具有父子层级关系</li>
</ul>
<p>一个典型的代码结构如下（官方starter使用Launcher启动的应用，本质上也是通过这种方式启动的）</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Verticle1</span> : <span class="type">AbstractVerticle</span></span>() &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">start</span><span class="params">()</span></span> &#123;</span><br><span class="line">        println(<span class="string">&quot;Verticle 1 started&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Verticle2</span> : <span class="type">AbstractVerticle</span></span>() &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">start</span><span class="params">()</span></span> &#123;</span><br><span class="line">        println(<span class="string">&quot;Verticle 2 started&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> vertx = Vertx.vertx();</span><br><span class="line">    vertx.deployVerticle(Verticle1::<span class="keyword">class</span>.java.canonicalName)</span><br><span class="line">    vertx.deployVerticle(Verticle2::<span class="keyword">class</span>.java.canonicalName)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>我们需要探究的问题是</p>
<ul>
<li>deployVerticle时发生了什么？</li>
<li>start()和stop()方法什么时候被调用？</li>
<li>如何保证一个Verticle下的所有操作都在一个EventLoop线程上执行？</li>
<li>父子层级关系如何维持？有什么作用？</li>
</ul>
<p>要搞清楚这些问题，我们先看几个与此相关的类</p>
<h3 id="Deployment"><a href="#Deployment" class="headerlink" title="Deployment"></a>Deployment</h3><p>维护一个发布状态，父子状态也是由它维护的。其唯一实现类DeploymentImpl是作为DeploymentManager的私有内部类存在的。这意味着Verticle发布的所有操作都在DeploymentManager内完成。</p>
<p>其中可能需要解释的点是getVerticles()，这意味着一个Deployment可以有多个Verticle吗？一定程度上是，但仅当一个Verticle需要发布多个实例时，才会存在多个Verticle对象。</p>
<p><img src="https://img-blog.csdnimg.cn/20201003111022872.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3pvdTg5NDQ=,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>其中需要重点关注的方法是<code>io.vertx.core.impl.DeploymentManager.DeploymentImpl#doUndeploy</code>和<code>io.vertx.core.impl.DeploymentManager.DeploymentImpl#doUndeployChildren</code>，两个方法递归调用，完成了指定Verticle及其子Verticle的取消。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> Future&lt;Void&gt; <span class="title">doUndeploy</span><span class="params">(ContextInternal undeployingContext)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (status == ST_UNDEPLOYED) &#123;</span><br><span class="line">        <span class="keyword">return</span> Future.failedFuture(<span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Already undeployed&quot;</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 子发布不为空，则先取消子发布，成功后再取消当前发布。</span></span><br><span class="line">    <span class="keyword">if</span> (!children.isEmpty()) &#123;</span><br><span class="line">        status = ST_UNDEPLOYING;</span><br><span class="line">        <span class="keyword">return</span> doUndeployChildren(undeployingContext).compose(v -&gt; doUndeploy(undeployingContext));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 子发布为空、或取消子发布完成，现在来取消当前发布</span></span><br><span class="line">        status = ST_UNDEPLOYED;</span><br><span class="line">        List&lt;Future&gt; undeployFutures = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">            parent.removeChild(<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 为当前发布的每个Verticle实例执行此操作</span></span><br><span class="line">        <span class="keyword">for</span> (VerticleHolder verticleHolder: verticles) &#123;</span><br><span class="line">            ContextImpl context = verticleHolder.context;</span><br><span class="line">            Promise p = Promise.promise();</span><br><span class="line">            undeployFutures.add(p.future());</span><br><span class="line">            <span class="comment">// 该context是Verticle发布时就存好的，调用它保证了Verticle的stop和start方法在同一个线程运行。</span></span><br><span class="line">            context.runOnContext(v -&gt; &#123;</span><br><span class="line">                Promise&lt;Void&gt; stopPromise = Promise.promise();</span><br><span class="line">                Future&lt;Void&gt; stopFuture = stopPromise.future();</span><br><span class="line">                stopFuture.setHandler(ar -&gt; &#123;</span><br><span class="line">                    <span class="comment">// 从deployments映射中移除</span></span><br><span class="line">                    deployments.remove(deploymentID);</span><br><span class="line">                    VertxMetrics metrics = vertx.metricsSPI();</span><br><span class="line">                    <span class="keyword">if</span> (metrics != <span class="keyword">null</span>) &#123;</span><br><span class="line">                        metrics.verticleUndeployed(verticleHolder.verticle);</span><br><span class="line">                    &#125;</span><br><span class="line">                    context.runCloseHooks(ar2 -&gt; &#123;</span><br><span class="line">                        <span class="keyword">if</span> (ar2.failed()) &#123;</span><br><span class="line">                            <span class="comment">// Log error but we report success anyway</span></span><br><span class="line">                            log.error(<span class="string">&quot;Failed to run close hook&quot;</span>, ar2.cause());</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">if</span> (ar.succeeded()) &#123;</span><br><span class="line">                            p.complete();</span><br><span class="line">                        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ar.failed()) &#123;</span><br><span class="line">                            p.fail(ar.cause());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;);</span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// 执行Verticle的stop方法</span></span><br><span class="line">                    verticleHolder.verticle.stop(stopPromise);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!stopPromise.tryFail(t)) &#123;</span><br><span class="line">                        undeployingContext.reportException(t);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        Promise&lt;Void&gt; resolvingPromise = undeployingContext.promise();</span><br><span class="line">        CompositeFuture.all(undeployFutures).&lt;Void&gt;mapEmpty().setHandler(resolvingPromise);</span><br><span class="line">        <span class="keyword">return</span> resolvingPromise.future();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> Future&lt;Void&gt; <span class="title">doUndeployChildren</span><span class="params">(ContextInternal undeployingContext)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!children.isEmpty()) &#123;</span><br><span class="line">        List&lt;Future&gt; childFuts = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">        <span class="comment">// 对每个子发布执行doUndeploy方法</span></span><br><span class="line">        <span class="keyword">for</span> (Deployment childDeployment: <span class="keyword">new</span> HashSet&lt;&gt;(children)) &#123;</span><br><span class="line">            Promise&lt;Void&gt; p = Promise.promise();</span><br><span class="line">            childFuts.add(p.future());</span><br><span class="line">            childDeployment.doUndeploy(undeployingContext, ar -&gt; &#123;</span><br><span class="line">                children.remove(childDeployment);</span><br><span class="line">                p.handle(ar);</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> CompositeFuture.all(childFuts).mapEmpty();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Future.succeededFuture();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>总结如下</p>
<ul>
<li>一个Verticle被取消，则其所有子Verticle都会被取消</li>
<li>VerticleHolder中存储了Verticle对应的Context，因此能够保证Verticle的所有生命周期方法都在同一个Context中执行。</li>
</ul>
<h3 id="DeploymentManager"><a href="#DeploymentManager" class="headerlink" title="DeploymentManager"></a>DeploymentManager</h3><p>DeploymentManager专门用于Verticle发布。</p>
<p><img src="https://img-blog.csdnimg.cn/20201003111046409.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3pvdTg5NDQ=,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"></p>
<p>重点方法在如下几个</p>
<ul>
<li><code>DeploymentManager#doDeploy(DeploymentOptions, Function&lt;Verticle,String&gt;, ContextInternal, ContextInternal,ClassLoader, Callable&lt;io.vertx.core.Verticle&gt;)</code></li>
<li><code>DeploymentManager#undeployVerticle(String)</code></li>
</ul>
<h4 id="发布"><a href="#发布" class="headerlink" title="发布"></a>发布</h4><p>发布代码如下</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Future&lt;Deployment&gt; <span class="title">doDeploy</span><span class="params">(String identifier,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    DeploymentOptions options,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    ContextInternal parentContext,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    ContextInternal callingContext,</span></span></span><br><span class="line"><span class="params"><span class="function">                                    ClassLoader tccl, Verticle... verticles)</span> </span>&#123;</span><br><span class="line">    Promise&lt;Deployment&gt; promise = callingContext.promise();</span><br><span class="line">    String poolName = options.getWorkerPoolName();</span><br><span class="line"></span><br><span class="line">    Deployment parent = parentContext.getDeployment();</span><br><span class="line">    <span class="comment">// 生成发布ID</span></span><br><span class="line">    String deploymentID = generateDeploymentID();</span><br><span class="line">    <span class="comment">// 创建Deployment对象，上面有说过它是干啥的</span></span><br><span class="line">    DeploymentImpl deployment = <span class="keyword">new</span> DeploymentImpl(parent, deploymentID, identifier, options);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 发布计数</span></span><br><span class="line">    AtomicInteger deployCount = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line">    <span class="comment">// 失败标示</span></span><br><span class="line">    AtomicBoolean failureReported = <span class="keyword">new</span> AtomicBoolean();</span><br><span class="line">    <span class="comment">// 如果一个Verticle发布多个实例，则会有多个verticle对象</span></span><br><span class="line">    <span class="keyword">for</span> (Verticle verticle: verticles) &#123;</span><br><span class="line">        <span class="comment">// Verticle可以被要求发布到Worker线程池还是EventLoop线程池，在这里做区分</span></span><br><span class="line">        WorkerExecutorInternal workerExec = poolName != <span class="keyword">null</span> ? vertx.createSharedWorkerExecutor(poolName, options.getWorkerPoolSize(), options.getMaxWorkerExecuteTime(), options.getMaxWorkerExecuteTimeUnit()) : <span class="keyword">null</span>;</span><br><span class="line">        WorkerPool pool = workerExec != <span class="keyword">null</span> ? workerExec.getPool() : <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// 为每个Verticle都创建一个新的Context</span></span><br><span class="line">        ContextImpl context = (ContextImpl) (options.isWorker() ? vertx.createWorkerContext(deployment, pool, tccl) :</span><br><span class="line">                                             vertx.createEventLoopContext(deployment, pool, tccl));</span><br><span class="line">        <span class="keyword">if</span> (workerExec != <span class="keyword">null</span>) &#123;</span><br><span class="line">            context.addCloseHook(workerExec);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 向Deployment加入Verticle对象</span></span><br><span class="line">        deployment.addVerticle(<span class="keyword">new</span> VerticleHolder(verticle, context));</span><br><span class="line">        <span class="comment">// 在新创建的Context上执行Verticle生命周期</span></span><br><span class="line">        context.runOnContext(v -&gt; &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 执行init方法</span></span><br><span class="line">                verticle.init(vertx, context);</span><br><span class="line">                Promise&lt;Void&gt; startPromise = context.promise();</span><br><span class="line">                Future&lt;Void&gt; startFuture = startPromise.future();</span><br><span class="line">                <span class="comment">// 执行start方法</span></span><br><span class="line">                verticle.start(startPromise);</span><br><span class="line">                startFuture.setHandler(ar -&gt; &#123;</span><br><span class="line">                    <span class="keyword">if</span> (ar.succeeded()) &#123;</span><br><span class="line">                        <span class="keyword">if</span> (parent != <span class="keyword">null</span>) &#123;</span><br><span class="line">                            <span class="comment">// 发布成功，加入父节点</span></span><br><span class="line">                            <span class="keyword">if</span> (parent.addChild(deployment)) &#123;</span><br><span class="line">                                deployment.child = <span class="keyword">true</span>;</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                <span class="comment">// Orphan</span></span><br><span class="line">                                deployment.undeploy(event -&gt; promise.fail(<span class="string">&quot;Verticle deployment failed.Could not be added as child of parent verticle&quot;</span>));</span><br><span class="line">                                <span class="keyword">return</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="comment">// 加入发布完成的map</span></span><br><span class="line">                        deployments.put(deploymentID, deployment);</span><br><span class="line">                        <span class="comment">// 发布的数量和待发布的数量匹配，说明发布完成，成功结束</span></span><br><span class="line">                        <span class="keyword">if</span> (deployCount.incrementAndGet() == verticles.length) &#123;</span><br><span class="line">                            promise.complete(deployment);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (failureReported.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">                        <span class="comment">// 发布失败的回滚</span></span><br><span class="line">                        deployment.rollback(callingContext, promise, context, ar.cause());</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                <span class="keyword">if</span> (failureReported.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>))</span><br><span class="line">                    deployment.rollback(callingContext, promise, context, t);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> promise.future();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>总结如下</p>
<ul>
<li>对每个verticle，vertx都会创建一个新的Context，因此每个verticle之间是相互独立的(一个Context代表了一个EventLoop线程。)</li>
<li>传入init和start方法的vertx实例，是DeploymentManager中维护的，它是在Vertx.vertx()创建时赋予的，整个应用一个。</li>
<li>整个verticle的内容都通过Context.runOnContext注册运行，所以它们才会始终都在一个线程上执行，并且执行顺序从上到下，不存在多线程竞争问题。</li>
<li>发布完成的Deployment会被加入DeploymentManager维护的deployments映射中，方便进行查找和之后的使用。</li>
</ul>
<h4 id="取消发布"><a href="#取消发布" class="headerlink" title="取消发布"></a>取消发布</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Future&lt;Void&gt; <span class="title">undeployVerticle</span><span class="params">(String deploymentID)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 从deployments中获取Deployment对象</span></span><br><span class="line">    Deployment deployment = deployments.get(deploymentID);</span><br><span class="line">    <span class="comment">// 获取当前上下文</span></span><br><span class="line">    Context currentContext = vertx.getOrCreateContext();</span><br><span class="line">    <span class="keyword">if</span> (deployment == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> ((ContextInternal) currentContext).failedFuture(<span class="keyword">new</span> IllegalStateException(<span class="string">&quot;Unknown deployment&quot;</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 调用deployment的undeploy()</span></span><br><span class="line">        <span class="keyword">return</span> deployment.undeploy();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Deployment.undeploy()在上面介绍Deployment时已介绍。</p>
<h3 id="VerticleManager"><a href="#VerticleManager" class="headerlink" title="VerticleManager"></a>VerticleManager</h3><p>DeploymentManager专注于发布，VerticleManager则主要专注于Verticle的创建。其内部持有一个DeploymentManager对象，用于执行实际的发布操作。</p>
<p><img src="https://img-blog.csdnimg.cn/20201003111106890.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3pvdTg5NDQ=,size_16,color_FFFFFF,t_70#pic_center" alt="在这里插入图片描述"><br>该类中有两个主要逻辑</p>
<ul>
<li>VerticleFactory的注册、取消、查找等。可以实现自定义的VerticleFactory，这里不深入。</li>
<li>Verticle的发布和创建的逻辑：调用VerticleFactory创建Verticle实例，在调用DeploymentManager.deploy()发布，代码过长，不给出。</li>
</ul>
<h3 id="所以Verticle是如何工作的？"><a href="#所以Verticle是如何工作的？" class="headerlink" title="所以Verticle是如何工作的？"></a>所以Verticle是如何工作的？</h3><p>这里回答最初提出的四个问题，就能解释Verticle是如何工作的。</p>
<ul>
<li><p>deployVerticle时发生了什么？</p>
<p>创建Verticle对象 -&gt; 创建Context并和Verticle对象绑定 -&gt; 构建Deployment并存起来 -&gt; 执行init() -&gt; 执行start() -&gt; 完成</p>
</li>
<li><p>start()和stop()方法什么时候被调用？</p>
<p>start(): 发布时，在新创建的Context上执行。</p>
<p>stop(): 取消发布时，在与该Verticle绑定的Context上执行。</p>
</li>
<li><p>如何保证一个Verticle下的所有操作都在一个EventLoop线程上执行？</p>
<p>通过将Context和Verticle绑定，调用start()和stop()时均在该Context下执行；而在start()和stop()中调用vertx的大多数操作，均是在调用代码块的当前Context下执行，而一个Context始终对应同一个EventLoop线程，如此即能保证一个Verticle下的所有操作都在同一个EventLoop线程上执行。</p>
</li>
<li><p>父子层级关系如何维持？有什么作用？</p>
<p>通过Deployment对象记录并维持。作用在于关闭一个Verticle时，其子Verticle也会被依次关闭。</p>
</li>
</ul>
<p>如此一来，Verticle几乎有了除容错机制外的所有的Actor模型的特性。</p>
<h2 id="数据共享机制"><a href="#数据共享机制" class="headerlink" title="数据共享机制"></a><strong>数据共享机制</strong></h2><p>Vertx提供了SharedData组件，用于为整个应用范围内提供共享组件，一个共享Map的使用大概如下</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Verticle1</span> : <span class="type">AbstractVerticle</span></span>() &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">start</span><span class="params">()</span></span> &#123;</span><br><span class="line">        println(<span class="string">&quot;Verticle 1 started&quot;</span>)</span><br><span class="line">        vertx.sharedData().getLocalAsyncMap&lt;String, String&gt;(<span class="string">&quot;myMap&quot;</span>).setHandler &#123; ar -&gt;</span><br><span class="line">                                                                                 ar.result().put(<span class="string">&quot;你好&quot;</span>, <span class="string">&quot;我是Verticle1&quot;</span>)</span><br><span class="line">                                                                                &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Verticle2</span> : <span class="type">AbstractVerticle</span></span>() &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">start</span><span class="params">()</span></span> &#123;</span><br><span class="line">        println(<span class="string">&quot;Verticle 2 started&quot;</span>)</span><br><span class="line">        vertx.sharedData().getLocalAsyncMap&lt;String, String&gt;(<span class="string">&quot;myMap&quot;</span>).setHandler &#123; ar -&gt;</span><br><span class="line">                                                                                 <span class="keyword">val</span> value = ar.result().<span class="keyword">get</span>(<span class="string">&quot;你好&quot;</span>).result()</span><br><span class="line">                                                                                 println(value)</span><br><span class="line">                                                                                &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> vertx = Vertx.vertx();</span><br><span class="line">    vertx.deployVerticle(Verticle1::<span class="keyword">class</span>.java.canonicalName)</span><br><span class="line">    Thread.sleep(<span class="number">1000</span>)</span><br><span class="line">    vertx.deployVerticle(Verticle2::<span class="keyword">class</span>.java.canonicalName)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>所有关于共享数据的内容都在io.vertx.core.shareddata包下，核心类是SharedDataImpl。</p>
<p>提供如下三种数据结构</p>
<ul>
<li><p>io.vertx.core.shareddata.impl.LocalAsyncLocks</p>
<p>异步排他锁，在集群内部有效的锁。其实现的思路如下</p>
<ul>
<li>维护一个ConcurrentMap，存储锁名和等待该锁的Handler列表</li>
<li>每次新来一个获取锁的请求，向等待列表中加入。并启动定时器开始计算超时，超时后直接回调锁等待超时。</li>
</ul>
<p>至此加入等待列表的逻辑完成。然后是锁流转逻辑。采用被动的逻辑，非常节省复杂度。</p>
<ul>
<li>当等待列表为空时，来一个请求就将锁给它；列表不为空时，仅加入等待列表，不做尝试获取锁的操作。</li>
<li>当一个锁被释放时，再主动将锁给等待列表的下一个请求。这样几乎从来不会出现竞争的情况。</li>
</ul>
</li>
<li><p>io.vertx.core.shareddata.impl.AsynchronousCounter</p>
<p>计数器，增减都是原子操作</p>
</li>
<li><p>io.vertx.core.shareddata.impl.LocalMapImpl</p>
<p>本地Map，用于单个实例中共享数据。仅是对ConcurrentMap的包装，没有其它特别之处。他的所有操作都是同步的。</p>
</li>
<li><p>io.vertx.core.shareddata.impl.LocalAsyncMapImpl</p>
<p>异步Map，同样是对ConcurrentMap的包装。不同之处在于其value是Holder类，它封装了TTL，实现原理是调用vertx.setTimer设置一个TTL长度的定时器，过期移除。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(K k, V v, <span class="keyword">long</span> timeout, Handler&lt;AsyncResult&lt;Void&gt;&gt; completionHandler)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> timestamp = System.nanoTime();</span><br><span class="line">    <span class="keyword">long</span> timerId = vertx.setTimer(timeout, l -&gt; removeIfExpired(k));</span><br><span class="line">    Holder&lt;V&gt; previous = map.put(k, <span class="keyword">new</span> Holder&lt;&gt;(v, timerId, timeout, timestamp));</span><br><span class="line">    <span class="keyword">if</span> (previous != <span class="keyword">null</span> &amp;&amp; previous.expires()) &#123;</span><br><span class="line">        vertx.cancelTimer(previous.timerId);</span><br><span class="line">    &#125;</span><br><span class="line">    completionHandler.handle(Future.succeededFuture());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可能有顾虑设置太多定时器不好，但vertx其实是将定时任务加入eventLoop线程去执行，因此并不会增加额外成本</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">setTimer</span><span class="params">(<span class="keyword">long</span> delay, Handler&lt;Long&gt; handler)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> scheduleTimeout(getOrCreateContext(), handler, delay, <span class="keyword">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">scheduleTimeout</span><span class="params">(ContextImpl context, Handler&lt;Long&gt; handler, <span class="keyword">long</span> delay, <span class="keyword">boolean</span> periodic)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (delay &lt; <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Cannot schedule a timer with delay &lt; 1 ms&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">long</span> timerId = timeoutCounter.getAndIncrement();</span><br><span class="line">    InternalTimerHandler task = <span class="keyword">new</span> InternalTimerHandler(timerId, handler, periodic, delay, context);</span><br><span class="line">    timeouts.put(timerId, task);</span><br><span class="line">    context.addCloseHook(task);</span><br><span class="line">    <span class="keyword">return</span> timerId;</span><br><span class="line">&#125;</span><br><span class="line">InternalTimerHandler(<span class="keyword">long</span> timerID, Handler&lt;Long&gt; runnable, <span class="keyword">boolean</span> periodic, <span class="keyword">long</span> delay, ContextImpl context) &#123;</span><br><span class="line">    <span class="keyword">this</span>.context = context;</span><br><span class="line">    <span class="keyword">this</span>.timerID = timerID;</span><br><span class="line">    <span class="keyword">this</span>.handler = runnable;</span><br><span class="line">    <span class="keyword">this</span>.periodic = periodic;</span><br><span class="line">    EventLoop el = context.nettyEventLoop();</span><br><span class="line">    <span class="keyword">if</span> (periodic) &#123;</span><br><span class="line">        future = el.scheduleAtFixedRate(<span class="keyword">this</span>, delay, delay, TimeUnit.MILLISECONDS);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        future = el.schedule(<span class="keyword">this</span>, delay, TimeUnit.MILLISECONDS);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (metrics != <span class="keyword">null</span>) &#123;</span><br><span class="line">        metrics.timerCreated(timerID);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="框图"><a href="#框图" class="headerlink" title="框图"></a><strong>框图</strong></h2><p>有待为每个工作原理都加上框图</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a><strong>总结</strong></h2><p>Vertx核心为EventBus、EventLoop，以及Verticle。这里通过先展示核心类的能力和实现原理，让读者有一个具象的认识，了解每个核心类大概有能干什么。然后通过EventBus的简单收发分析，展示了EventBus的工作原理及EventLoop参与代码执行的方式；通过Verticle的发布，展示了Verticle是如何运转的，以及Verticle的线程安全特性得到保障的原因；最后展示了SharedData进行应用范围内数据共享的实现原理。让读者对Vert.x核心部分有了较为深入的认识。</p>
<p>当然，Vert.x的能力远不止于此，这里仅介绍了单机版运行原理，它还支持集群和高可用特性，都是本文没有覆盖到的；此外，核心部分的文件系统、网络编程相关内容也均未介绍，这些留待之后再说。</p>
<p>最后，总结一波一些核心组件相互之间的关系。</p>
<ul>
<li>一般来说，一个应用只有一个Vertx，在整个应用中传来传去的vertx实例，都是一个，除非我们想要拥有完全隔离的EventBus。</li>
<li>一个Vertx实例只持有一个EventBus和一个用于日常调度的EventLoopGroup(用于网络服务监听的不算)。</li>
<li>一个Vertx实例持有多个线程池，我们最常解除的只有EventLoopGroup和WorkerPool。</li>
<li>一个Context只持有一个EventLoop，即只对应一个线程。通过runOnContext()将任务调度到该EventLoop上执行。</li>
<li>一个VerticleManager持有多个VerticleFactory。</li>
<li>一个DeployManager持有多个Deployment，Deployment之间的父子关系由Deployment自己维护。</li>
<li>一个Deployment可以持有多个Verticle实例，但仅能持有一个Verticle类型</li>
</ul>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zou8944.com/%E4%BD%BF%E7%94%A8JSON%20Schema%E9%AA%8C%E8%AF%81API%E5%93%8D%E5%BA%94-shi-yong-jsonschema-yan-zheng-api-xiang-ying/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="果冻 | Jelly">
      <meta itemprop="description" content="Beat Jelly; Hit Jelly; Kill Jelly.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="果冻 | Jelly">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E4%BD%BF%E7%94%A8JSON%20Schema%E9%AA%8C%E8%AF%81API%E5%93%8D%E5%BA%94-shi-yong-jsonschema-yan-zheng-api-xiang-ying/" class="post-title-link" itemprop="url">使用JSON Schema验证API响应</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-10-03 23:40:52" itemprop="dateCreated datePublished" datetime="2020-10-03T23:40:52+08:00">2020-10-03</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-11-08 16:25:55" itemprop="dateModified" datetime="2021-11-08T16:25:55+08:00">2021-11-08</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="API的响应需要约束"><a href="#API的响应需要约束" class="headerlink" title="API的响应需要约束"></a>API的响应需要约束</h2><p>目前我们开发Web API的方式是通过定义Open API描述文件来定义请求约束。约束能够保证所有请求参数按照正确的格式和必要性传输，从而规范化输入。这保护了服务端内部的安全——输入约束不变的情况下，输入的值总是合法可期的。</p>
<p>尽管Open API也提供了对Response Body的定义，允许用户描述响应的消息格式，但由于其不具有强制性——语法上可以不写，写了也不与实际返回内容有深入结合，因此无法验证真实API的响应是否符合预期，这也是从一开始不愿写响应体的原因。</p>
<p>而关于验证API响应的重要性，是不言而喻的，截止目前，至少有两个时刻让我有了“如果能够在单元测试就验证响应体格式就好了”的想法。</p>
<p>其一：今年上半年的一次down time，彼时是上线真米视频，其video id要做到可控（手动编写，数位字符串），而原逻辑使用了阿里云生成的video id——32位字符串。使用的方案是将手动生成的video id替换了阿里云video id，结果由于测试上的不周全导致所有视频的video id都被替换，对于那些没有分配手动id的音视频，其video id自然变成了null。而该问题因为机缘巧合对视频无影响，仅对音频产生影响。导致较长时间才发现。回首该问题，出在video id字段的格式上，如果有对响应体做约束——要求video id必须有值，且长度为32位，则该问题能够在单元测试就发现。</p>
<p>其二：呼啦亲子项目已进行了多次迭代，大致如下</p>
<ul>
<li>初版</li>
<li>增加了呼啦圈，其内容与文章接近，封面图需要记录宽高和媒体类型；为了保持格式一致，原本文章的封面格式也改为如此</li>
<li>首页文章的封面的显示增加多图效果，其它页面保持原有格式不变，且多图效果要求类随机——即要对封面字段格式化输出</li>
<li>创作者中心用于编辑上面多图的选项，因此获取的封面字段要原样输出</li>
<li>每一次升级都要兼容之前的版本</li>
</ul>
<p>光看文章这一项的元数据，就有下面四种格式</p>
<p>首页文章格式（其中coverSrc用于兼容最初版本、cover用于兼容次初版本API、covers+style是最新版的API需要的字段）</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;meta&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;各国孩子吃什么零食之法国篇&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;covers&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;https://qinzi.static.hulaplanet.com/ttp/editor/94d53aa2e67acaf5bdac445eb1ed2144.jpg?x-oss-process=image/auto-orient,1/interlace,1/resize,m_lfit,w_828/quality,q_90/format,jpg&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;width&quot;</span>: <span class="number">800</span>,</span><br><span class="line">            <span class="attr">&quot;height&quot;</span>: <span class="number">600</span>,</span><br><span class="line">            <span class="attr">&quot;mediaType&quot;</span>: <span class="string">&quot;image&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;coverSrc&quot;</span>: <span class="string">&quot;https://qinzi.static.hulaplanet.com/ttp/editor/94d53aa2e67acaf5bdac445eb1ed2144.jpg&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;cover&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;https://qinzi.static.hulaplanet.com/ttp/editor/94d53aa2e67acaf5bdac445eb1ed2144.jpg?x-oss-process=image/auto-orient,1/interlace,1/resize,m_lfit,w_828/quality,q_90/format,jpg&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;width&quot;</span>: <span class="number">800</span>,</span><br><span class="line">        <span class="attr">&quot;height&quot;</span>: <span class="number">600</span>,</span><br><span class="line">        <span class="attr">&quot;mediaType&quot;</span>: <span class="string">&quot;image&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;style&quot;</span>: <span class="string">&quot;singleMinImage&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>普通文章列表页格式（多图显示仅对首页生效，普通列表页保持次初版本格式）</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;meta&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;各国孩子吃什么零食之法国篇&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;coverSrc&quot;</span>: <span class="string">&quot;https://qinzi.static.hulaplanet.com/ttp/editor/94d53aa2e67acaf5bdac445eb1ed2144.jpg&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;cover&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;https://qinzi.static.hulaplanet.com/ttp/editor/94d53aa2e67acaf5bdac445eb1ed2144.jpg?x-oss-process=image/auto-orient,1/interlace,1/resize,m_lfit,w_828/quality,q_90/format,jpg&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;width&quot;</span>: <span class="number">800</span>,</span><br><span class="line">        <span class="attr">&quot;height&quot;</span>: <span class="number">600</span>,</span><br><span class="line">        <span class="attr">&quot;mediaType&quot;</span>: <span class="string">&quot;image&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>文章详情页格式（多出来了jsVersion和cssVersion）</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;meta&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;各国孩子吃什么零食之法国篇&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;coverSrc&quot;</span>: <span class="string">&quot;https://qinzi.static.hulaplanet.com/ttp/editor/94d53aa2e67acaf5bdac445eb1ed2144.jpg&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;cover&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;https://qinzi.static.hulaplanet.com/ttp/editor/94d53aa2e67acaf5bdac445eb1ed2144.jpg?x-oss-process=image/auto-orient,1/interlace,1/resize,m_lfit,w_828/quality,q_90/format,jpg&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;width&quot;</span>: <span class="number">800</span>,</span><br><span class="line">        <span class="attr">&quot;height&quot;</span>: <span class="number">600</span>,</span><br><span class="line">        <span class="attr">&quot;mediaType&quot;</span>: <span class="string">&quot;image&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;jsVersion&quot;</span>: <span class="string">&quot;awbegiwaubegwug&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;cssVersion&quot;</span>: <span class="string">&quot;weignwoegowibhg&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>创作者中心文章格式（多出来了jsVersion, cssVersion, coverDisplayCount(用于用户选择该文章显示几张图)）</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;meta&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;title&quot;</span>: <span class="string">&quot;各国孩子吃什么零食之法国篇&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;covers&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="attr">&quot;url&quot;</span>: <span class="string">&quot;https://qinzi.static.hulaplanet.com/ttp/editor/94d53aa2e67acaf5bdac445eb1ed2144.jpg?x-oss-process=image/auto-orient,1/interlace,1/resize,m_lfit,w_828/quality,q_90/format,jpg&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;width&quot;</span>: <span class="number">800</span>,</span><br><span class="line">            <span class="attr">&quot;height&quot;</span>: <span class="number">600</span>,</span><br><span class="line">            <span class="attr">&quot;mediaType&quot;</span>: <span class="string">&quot;image&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">    ],,</span><br><span class="line">    <span class="attr">&quot;jsVersion&quot;</span>: <span class="string">&quot;awbegiwaubegwug&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;cssVersion&quot;</span>: <span class="string">&quot;weignwoegowibhg&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;coverDisplayCount&quot;</span>: <span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>一个文章的mata就有四种格式，再加上呼啦圈的meta格式，如果需要同时对他们进行修改，一定会令人相当头大。此时如果能够在单元测试约束meta的格式，要求哪些字段是必须的，不需要哪些字段，则可大大减轻心智负担，对API质量也是一个保证。</p>
<h2 id="可能的约束方法"><a href="#可能的约束方法" class="headerlink" title="可能的约束方法"></a>可能的约束方法</h2><p>那么有什么好的方法来做这件事呢？一般我们有几种方法</p>
<p><strong>编程测试</strong></p>
<p>最原始也是最直接的方法，直接编程验证每个字段的格式。这种方式砖量太大，如果要对拥有数十个字段的响应，针对每个字段验证类型、长度、多余字段等。如果多几个这样的接口，会头晕的。</p>
<p>有针对此做一些优化的，即使用一些json validator进行验证，但这些工具的局限性太大，不能完全满足需求。</p>
<p>使用编程测试最终的归宿很可能会变成只测试几个重要的字段的格式，但<strong>往往出问题的都是没有关注的字段，而重视的字段一般没那么容易出问题</strong>。</p>
<p><strong>使用JSON Schema</strong></p>
<p>铺垫那么多，就是想说JSON Schema。一个真正满足需求的东西。JSON Schema是一个规范，用于全方位描述json的格式，包括一个json中必须包含哪些字段、只能包含哪些字段、字段的类型、是否可为空、字段最大最小值、字段的长度等。如同我们使用Open API描述文件来描述我们接口的输入参数；使用JSON Schema描述API响应消息体并在单元测试进行验证。这样把控API输入和输出，在安全性上会有比较大的提升。</p>
<h2 id="Json-Schema"><a href="#Json-Schema" class="headerlink" title="Json Schema"></a>Json Schema</h2><p>JSON Schema官网<a target="_blank" rel="noopener" href="https://json-schema.org/%EF%BC%8C%E7%9B%AE%E5%89%8D%E6%9C%80%E6%96%B0%E7%89%88%E6%98%AF2019-09">https://json-schema.org/，目前最新版是2019-09</a>.</p>
<p>按照官网的话说，JSON Schema是一个用于描述和验证JSON文档的规范。</p>
<p>使用JSON Schema时最大的问题是会把描述文件写得太大，尤其是使用JSON Schema生成工具(<a target="_blank" rel="noopener" href="https://jsonschema.net/home)%E6%97%B6%E3%80%82%E5%88%9A%E5%BC%80%E5%A7%8B%E5%B0%86/feeds%E6%8E%A5%E5%8F%A3%E7%9A%84%E5%93%8D%E5%BA%94%E8%87%AA%E5%8A%A8%E7%94%9F%E6%88%90%E4%BA%86%E6%95%B0%E7%99%BE%E8%A1%8C%E6%8F%8F%E8%BF%B0%E6%96%87%E4%BB%B6%EF%BC%8C%E8%BF%99%E6%97%A0%E7%96%91%E6%98%AF%E4%B8%8D%E5%8F%AF%E6%8E%A5%E5%8F%97%E7%9A%84%E3%80%82">https://jsonschema.net/home)时。刚开始将/feeds接口的响应自动生成了数百行描述文件，这无疑是不可接受的。</a></p>
<p>解决此问题的最好办法，以目前我的认知来看，是全部手写+定义复用的方式——仅增加自己需要的特性，再将公共结构抽取出来，在合适的地方使用$ref引用。具体可参考<a target="_blank" rel="noopener" href="https://json-schema.org/understanding-json-schema/structuring.html">如何定义一个复杂的schema</a>（该文章对应的书籍<a target="_blank" rel="noopener" href="https://json-schema.org/understanding-json-schema/index.html">Understanding Json Schema</a>也是学习JSON Schema的不错的资料）。</p>
<p>同时，官网也列出了<a target="_blank" rel="noopener" href="https://json-schema.org/implementations.html">各语言下验证JSON Schema的库</a>，在Java下，我推荐<a target="_blank" rel="noopener" href="https://github.com/networknt/json-schema-validator">这个</a></p>
<h2 id="使用JSON-Schema"><a href="#使用JSON-Schema" class="headerlink" title="使用JSON Schema"></a>使用JSON Schema</h2><p>我们举例如何使用JSON SChema验证/feeds接口文章类型的数据</p>
<h3 id="定义Schema"><a href="#定义Schema" class="headerlink" title="定义Schema"></a>定义Schema</h3><h4 id="公共属性"><a href="#公共属性" class="headerlink" title="公共属性"></a>公共属性</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;$schema&quot;</span>: <span class="string">&quot;http://json-schema.org/draft-07/schema#&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;definitions&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;nullableString&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;oneOf&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;null&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;encodedId&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;minLength&quot;</span>: <span class="number">20</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;mediaType&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;enum&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;image&quot;</span>,</span><br><span class="line">        <span class="string">&quot;video&quot;</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;stateEnum&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;enum&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;normal&quot;</span>,</span><br><span class="line">        <span class="string">&quot;draft&quot;</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;postFeedStyle&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;enum&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;textOnly&quot;</span>,</span><br><span class="line">        <span class="string">&quot;singleMinImage&quot;</span>,</span><br><span class="line">        <span class="string">&quot;singleMaxImage&quot;</span>,</span><br><span class="line">        <span class="string">&quot;twoImages&quot;</span>,</span><br><span class="line">        <span class="string">&quot;threeImages&quot;</span></span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="作者"><a href="#作者" class="headerlink" title="作者"></a>作者</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;$schema&quot;</span>: <span class="string">&quot;http://json-schema.org/draft-07/schema#&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;object&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;id&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;$ref&quot;</span>: <span class="string">&quot;../../public-definitions.json#/definitions/encodedId&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;nickname&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;$ref&quot;</span>: <span class="string">&quot;../../public-definitions.json#/definitions/nullableString&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;avatar&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;$ref&quot;</span>: <span class="string">&quot;../../public-definitions.json#/definitions/nullableString&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;required&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;id&quot;</span>,</span><br><span class="line">    <span class="string">&quot;nickname&quot;</span>,</span><br><span class="line">    <span class="string">&quot;avatar&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;additionalProperties&quot;</span>: <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="媒体类型"><a href="#媒体类型" class="headerlink" title="媒体类型"></a>媒体类型</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;$schema&quot;</span>: <span class="string">&quot;http://json-schema.org/draft-07/schema#&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;object&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;url&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;$ref&quot;</span>: <span class="string">&quot;../../public-definitions.json#/definitions/nullableString&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;width&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;integer&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;height&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;integer&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;mediaType&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;$ref&quot;</span>: <span class="string">&quot;../../public-definitions.json#/definitions/mediaType&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;required&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;url&quot;</span>,</span><br><span class="line">    <span class="string">&quot;width&quot;</span>,</span><br><span class="line">    <span class="string">&quot;height&quot;</span>,</span><br><span class="line">    <span class="string">&quot;mediaType&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;additionalProperties&quot;</span>: <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="标签类型"><a href="#标签类型" class="headerlink" title="标签类型"></a>标签类型</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;$schema&quot;</span>: <span class="string">&quot;http://json-schema.org/draft-07/schema#&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;object&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;id&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;$ref&quot;</span>: <span class="string">&quot;../../public-definitions.json#/definitions/encodedId&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;name&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;hotted&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;boolean&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;required&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;id&quot;</span>,</span><br><span class="line">    <span class="string">&quot;name&quot;</span>,</span><br><span class="line">    <span class="string">&quot;hotted&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;additionalProperties&quot;</span>: <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="元数据"><a href="#元数据" class="headerlink" title="元数据"></a>元数据</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;$schema&quot;</span>: <span class="string">&quot;http://json-schema.org/draft-07/schema#&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;object&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;title&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;coverSrc&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;string&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;为了兼容最初的API而留存的字段&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;cover&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;$ref&quot;</span>: <span class="string">&quot;../../base/media.json&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;为了兼容V2.0前期而存在的字段&quot;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;covers&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;array&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;description&quot;</span>: <span class="string">&quot;目前线上版本在用的字段&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;items&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;$ref&quot;</span>: <span class="string">&quot;../../base/media.json&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;style&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;$ref&quot;</span>: <span class="string">&quot;../../../public-definitions.json#/definitions/postFeedStyle&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;required&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;title&quot;</span>,</span><br><span class="line">    <span class="string">&quot;cover&quot;</span>,</span><br><span class="line">    <span class="string">&quot;covers&quot;</span>,</span><br><span class="line">    <span class="string">&quot;coverSrc&quot;</span>,</span><br><span class="line">    <span class="string">&quot;style&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;additionalProperties&quot;</span>: <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="汇总成-feeds接口返回的数据"><a href="#汇总成-feeds接口返回的数据" class="headerlink" title="汇总成/feeds接口返回的数据"></a>汇总成/feeds接口返回的数据</h4><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;$schema&quot;</span>: <span class="string">&quot;http://json-schema.org/draft-07/schema#&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;object&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;definitions&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;item&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;allOf&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;$ref&quot;</span>: <span class="string">&quot;base/public-properties.json&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;meta&quot;</span>: &#123;</span><br><span class="line">              <span class="attr">&quot;$ref&quot;</span>: <span class="string">&quot;base/meta-feed.json&quot;</span></span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="attr">&quot;author&quot;</span>: &#123;</span><br><span class="line">              <span class="attr">&quot;$ref&quot;</span>: <span class="string">&quot;../base/author.json&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;required&quot;</span>: [</span><br><span class="line">            <span class="string">&quot;meta&quot;</span>,</span><br><span class="line">            <span class="string">&quot;author&quot;</span></span><br><span class="line">          ]</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;properties&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;list&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;array&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;items&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;$ref&quot;</span>: <span class="string">&quot;#/definitions/item&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;required&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;list&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>可以看到，最终定义的文章schema也没有很长，而前面的公共属性、作者等提取出来的结构由于会被众多其它定义使用，因此总体长度是可以接受的。</p>
<h3 id="使用schema验证响应体"><a href="#使用schema验证响应体" class="headerlink" title="使用schema验证响应体"></a>使用schema验证响应体</h3><p>我们使用json-schema-validator库加载定义好的schema来验证接口响应。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> WebClient.<span class="title">validateAPIResponseSchema</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  path: <span class="type">String</span>, params: <span class="type">Map</span>&lt;<span class="type">String</span>, String&gt; = mapOf()</span></span>, schemaPath: String</span><br><span class="line">) &#123;</span><br><span class="line">  <span class="keyword">val</span> request = <span class="keyword">this</span></span><br><span class="line">    .<span class="keyword">get</span>(path)</span><br><span class="line">    .host(serverHost)</span><br><span class="line">    .port(serverPort)</span><br><span class="line">    .putHeader(<span class="string">&quot;token&quot;</span>, testToken)</span><br><span class="line"></span><br><span class="line">  params.forEach &#123; (k, v) -&gt; request.addQueryParam(k, v) &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> response = request.<span class="keyword">expect</span>(ResponsePredicate.JSON)</span><br><span class="line">    .<span class="keyword">expect</span>(ResponsePredicate.SC_OK)</span><br><span class="line">    .sendAwait().bodyAsJsonObject()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> schemaURI = File(schemaPath).toURI()</span><br><span class="line">  <span class="keyword">val</span> schema = JsonSchemaFactory.getInstance(SpecVersion.VersionFlag.V7).getSchema(schemaURI)</span><br><span class="line">  <span class="keyword">val</span> node = withContext(Dispatchers.IO) &#123; ObjectMapper().readTree(response.encode()) &#125;</span><br><span class="line">  schema.assertLegal(node)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">testGetPostFeeds</span><span class="params">(vertx: <span class="type">Vertx</span>, tc: <span class="type">VertxTestContext</span>)</span></span> &#123;</span><br><span class="line">    launch5e(tc) &#123;</span><br><span class="line">      webClient.validateAPIResponseSchema(</span><br><span class="line">        path = <span class="string">&quot;/feeds&quot;</span>,</span><br><span class="line">        params = mapOf(<span class="string">&quot;content_type&quot;</span> to <span class="string">&quot;post&quot;</span>, <span class="string">&quot;limit&quot;</span> to <span class="string">&quot;20&quot;</span>),</span><br><span class="line">        schemaPath = <span class="string">&quot;src/main/resources/jsonschema/content/post/profile-feed.json&quot;</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>运行测试函数testGetPostFeeds，如果验证失败，可得到具体错误原因，方便排查。</p>
<p>至此，使用JSON Schema进行API响应的验证就完成了。只要描述文件不动，就能及时发现响应格式上的错误，保证了接口的正确性。</p>
<h2 id="Open-API与Json-Schema"><a href="#Open-API与Json-Schema" class="headerlink" title="Open API与Json Schema"></a>Open API与Json Schema</h2><p>不止一次前端或客户端的同志直接或间接要求我们写Response格式描述，但由于写起来耗时且该描述与实际响应没有强耦合关系，改动很可能不及时，带来很多问题。如果能够将上面定义的JSON Schema描述文件应用到Open API描述文件中，岂不美哉。</p>
<p>然而现实是残酷的，Swagger确实<a target="_blank" rel="noopener" href="https://swagger.io/docs/specification/data-models/keywords/">支持JSON Schema</a>，但支持的是个子集，因此无法直接使用上面定义的描述文件。美梦落空。。。淡淡的忧桑。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zou8944.com/%E9%9A%8F%E7%AC%94%20-%20%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BB%8E%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%8E%B7%E5%8F%96%E6%B6%88%E6%81%AF%E6%97%B6%E7%9A%84%E5%8E%9F%E7%90%86-sui-bi--xiao-xi-dui-lie-ke-hu-duan-cong-fu-wu-duan-huo-qu-xiao-xi-shi-de-yuan-li/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="果冻 | Jelly">
      <meta itemprop="description" content="Beat Jelly; Hit Jelly; Kill Jelly.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="果冻 | Jelly">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E9%9A%8F%E7%AC%94%20-%20%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%E5%AE%A2%E6%88%B7%E7%AB%AF%E4%BB%8E%E6%9C%8D%E5%8A%A1%E7%AB%AF%E8%8E%B7%E5%8F%96%E6%B6%88%E6%81%AF%E6%97%B6%E7%9A%84%E5%8E%9F%E7%90%86-sui-bi--xiao-xi-dui-lie-ke-hu-duan-cong-fu-wu-duan-huo-qu-xiao-xi-shi-de-yuan-li/" class="post-title-link" itemprop="url">随笔 - 消息队列客户端从服务端获取消息时的原理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-08-15 23:39:42" itemprop="dateCreated datePublished" datetime="2020-08-15T23:39:42+08:00">2020-08-15</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-02-16 23:40:19" itemprop="dateModified" datetime="2021-02-16T23:40:19+08:00">2021-02-16</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>同事：阿里云MNS获取消息的API使用起来不够方便，需要不断手动长轮询，看起来有点原始。<br>我：em。。。那其它消息队列使用什么方式？难道不是长轮询？</p>
</blockquote>
<p>在使用<a target="_blank" rel="noopener" href="https://help.aliyun.com/product/27412.html?spm=a2c4g.11186623.6.540.42f17e2f0aTqZl">阿里云MNS（Message Notification Service）</a>服务时，意识到其从服务端获取消息的方式是手动长轮询。写代码时可能会用到while-true看似危险的控制结构，而查看手册这也是官方推荐的使用方式。于是想找找其它消息队列拉取消息的原理。</p>
<h2 id="长轮询"><a href="#长轮询" class="headerlink" title="长轮询"></a>长轮询</h2><p>在此之前，我们首先做一些基础知识准备——什么是长轮询？<br>而要回答这个问题之前，我们需要区分：长连接、短链接、长轮询、短轮询。</p>
<h3 id="长连接、短连接"><a href="#长连接、短连接" class="headerlink" title="长连接、短连接"></a>长连接、短连接</h3><p>长短连接，指的的TCP连接。当客户端通过socket连接到服务端时，就建立了一个TCP连接，当双方都不关闭该连接时，它就是长连接。而如果在一次请求-响应后，关闭了这个TCP连接，则称这个连接为短链接。</p>
<p>在TCP协议中，并没有长连接、短连接的概念，这完全是根据使用方法区分。</p>
<p>需要注意TCP长连接会因为网络波动、操作系统环境等问题出现连接丢失的问题，需要进行额外的连接保活工作，如发送定时心跳（心跳保活机制在很多场景下都有使用，比如Zookeeper；比如AMQP）。</p>
<h3 id="长轮询、短轮询"><a href="#长轮询、短轮询" class="headerlink" title="长轮询、短轮询"></a>长轮询、短轮询</h3><p>轮询，即客户端与客户端不断重复 请求数据-消费数据 这一过程。有两种策略</p>
<ul>
<li>客户端请求，服务端有数据则返回数据，没有数据则返回空。</li>
<li>客户端请求，服务端有数据则返回数据，没有数据则将连接保持，等有数据时再返回。<h3 id="HTTP的keep-alive"><a href="#HTTP的keep-alive" class="headerlink" title="HTTP的keep-alive"></a>HTTP的keep-alive</h3>TCP是传输层协议，而HTTP是应用层协议。而头部Connection: Keep-Alive表示维持TCP连接，即我们常说的HTTP长连接。<br>Keep-Alive的工作原理如下：</li>
<li>客户端请求携带Connection: Keep-Alive头部，服务端接收后，会在响应该条HTTP请求后继续保持TCP连接；否则关闭。</li>
<li>客户端在收到的服务端响应后，如果有携带Connection: Keep-Alive头部，则会使用同一个TCP连接发送下一个HTTP请求。</li>
</ul>
<p>此外，Keep-Alive还可以设置timeout参数，用于指定预期的连接超时时间。</p>
<p>注意HTTP协议本身是一个请求-响应协议，无状态，即一个事务在请求-响应后就结束了，再次请求就是一个新事务。而HTTP协议中定义了几种HTTP连接：</p>
<ul>
<li>常规连接：即请求响应后即关闭TCP连接。</li>
<li>持久连接（又称长连接）：即可以传输多个事务的连接，传输后不关闭TCP连接，下次传输继续使用。对应Keep-Alive。</li>
<li>管道式连接：即在一个TCP连接上一次发送多个事务的请求，再依次接收多个事务的请求。传统的是一个事务的请求-响应完成后再进行下一个事务。</li>
</ul>
<h2 id="阿里云MNS"><a href="#阿里云MNS" class="headerlink" title="阿里云MNS"></a>阿里云MNS</h2><p>阿里云MNS的数据传输走的是HTTP协议，意味着无论是点对点、还是发布-订阅模式，都要通过HTTP来进行。这就导致了文章一开始所说的使用方式的问题，由于HTTP协议本身无状态，只能是客户端请求-服务端响应，客户端拉取数据时只能采用轮询的方式。而为了拉取操作过于频繁带来的损失，采用的长轮询：客户端请求，服务端没有消息时，挂起该连接，等到有消息时再响应。</p>
<p>也许你很好奇，如果走HTTP协议，那客户端如何订阅主题，即客户端如何被动收到消息？答案是设置回调地址；或将主题消息推送到另一个队列，然后长轮询该队列。</p>
<p>总之阿里云MNS获取消息的方式因为其采用HTTP传输协议而受到了限制。不过这也有一个好处，就是<strong>任何语言都能使用MNS服务</strong>，甚至不需要SDK，手动调起HTTP接口即可。</p>
<h2 id="RabbitMQ"><a href="#RabbitMQ" class="headerlink" title="RabbitMQ"></a>RabbitMQ</h2><p>RabbitMQ走的是AMQP协议，它和HTTP一样，也是应用层协议，构建于TCP之上。与HTTP不同的是，它专门设计用于消息传输。客户端和服务端采用TCP长连接，前面说过，只要建立了TCP连接，数据就能双向传输。这样就能做到客户端不需要主动轮询，服务端推送消息到客户端的效果。使用起来方便很多。对AMQP协议，就是Basic.Consume。</p>
<h2 id="WebSocket"><a href="#WebSocket" class="headerlink" title="WebSocket"></a>WebSocket</h2><p>既然说到了AMQP的双向传输功能，就联想到了WebSocket，它是如何实现双向传输的呢？在翻看一些资料后，发现它也是建立了一个持久的TCP连接，利用TCP双向传输的特性，实现服务端的消息推送。</p>
<p>通常说WebSocket时，是对比HTTP协议，HTTP协议无状态，事务间隔离，建立在请求-响应这样的被动机制下，在应用上无法实现服务端主动推送消息的场景。WebSocket的出现就是为了解决该问题，</p>
<p>如果把WebSocket和AMQP进行对比，在服务端主动发送消息到客户端这一点来说，二者原理一致。甚至可以说WebSocket是AMQP的功能子集。当然也不能这么说，毕竟他们目标不同，WebSocket聚焦于推送消息，而AMQP聚焦于消息模型的抽象，顺带解决消息传输的问题。且就消息推送这一点来说，尽管原理一致，实现方式可能也是不同的。</p>
<h2 id="还可深入探索的点"><a href="#还可深入探索的点" class="headerlink" title="还可深入探索的点"></a>还可深入探索的点</h2><p>当然消息队列除了上述两个，还有很多其它的，比如流行的Kafka、RocketMQ、ActiveMQ等。由于他们并不是基于AMQP协议，因此具体方式还不知道。不过我想，传输层都是TCP，实现双向传输的机制应该逃不过TCP长连接的。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zou8944.com/%E5%8C%BA%E5%88%86%E9%9A%8F%E7%AC%94%E5%92%8C%E6%AD%A3%E6%96%87-qu-fen-sui-bi-he-zheng-wen/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="果冻 | Jelly">
      <meta itemprop="description" content="Beat Jelly; Hit Jelly; Kill Jelly.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="果冻 | Jelly">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E5%8C%BA%E5%88%86%E9%9A%8F%E7%AC%94%E5%92%8C%E6%AD%A3%E6%96%87-qu-fen-sui-bi-he-zheng-wen/" class="post-title-link" itemprop="url">区分随笔和正文</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-08-15 23:37:17" itemprop="dateCreated datePublished" datetime="2020-08-15T23:37:17+08:00">2020-08-15</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-02-16 23:37:41" itemprop="dateModified" datetime="2021-02-16T23:37:41+08:00">2021-02-16</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="破掉的FLAG"><a href="#破掉的FLAG" class="headerlink" title="破掉的FLAG"></a>破掉的FLAG</h2><p>2019年8月11日，发布博文《我有点想要写博客了》，总结了之前一段时间的个人状态，并立下从那以后每月至少两篇博文的FLAG。如今一年过去了，不出所料，FLAG倒了。这一年间按计划应该又至少24篇新发布的文章，实际数量——20篇。且其中质量较好的不到10篇。考虑到立FLAG只有几个月里写的挺积极，则近几个月如果不是公司的一月一篇的硬性博客任务，恐怕会是触目惊心的0篇文章。</p>
<h2 id="冷启动"><a href="#冷启动" class="headerlink" title="冷启动"></a>冷启动</h2><h3 id="时间会消磨提笔的勇气"><a href="#时间会消磨提笔的勇气" class="headerlink" title="时间会消磨提笔的勇气"></a>时间会消磨提笔的勇气</h3><p>一件事，如果长时间不做，想再开始，难度会成倍上涨。这里说的难度来自各方面：心理的、生理的；自身因素、外界因素。这种现象在生活中大量存在：如果长时间不与人交流，突然和别人说话时会显得咬字不清或语无伦次；长时间不从事某项运动，想要再次开始并达到之前的运动水准需要较长时间；大脑长时间处于放空状态，反应会变慢。这种现象，我愿称之为<strong>冷启动</strong>。俗话说可以是刀久了不用会生锈。</p>
<p>就写博客而言，冷启动的阻力主要来自于思维和身体的惰性、文笔的生疏等方面，更重要的是会消磨掉你想要分享东西给别人的热情和勇气。</p>
<p>写代码也一样，作为一个程序员，如果长时间不写代码，对常用工具的生疏感、对自身的焦虑都会加深不自信，形成恶性循环。</p>
<h3 id="冷启动优化-预热"><a href="#冷启动优化-预热" class="headerlink" title="冷启动优化 - 预热"></a>冷启动优化 - 预热</h3><p>技术上讲，冷启动常用的优化方式是预热。即在刀生锈之前再磨一磨。曾遇到某云服务厂商的函数计算服务长时间不调用会因冷启动时间过长而导致响应超时，解决方式就是预热，因此对此音箱深刻。</p>
<p>写博客的预热方式，就是——常写。</p>
<h2 id="随笔和正文"><a href="#随笔和正文" class="headerlink" title="随笔和正文"></a>随笔和正文</h2><h3 id="预热的成本和价值"><a href="#预热的成本和价值" class="headerlink" title="预热的成本和价值"></a>预热的成本和价值</h3><p>预热的成本不可太高，过高的成本会占用过多资源，相对地，正式任务的资源会减少；且对现实意义来说，预热这一操作必须具有一定的价值，不能为了预热而预热。比如用于保持状态（预热）的博客必须具有价值，不能太水。</p>
<h3 id="随笔和正文-1"><a href="#随笔和正文-1" class="headerlink" title="随笔和正文"></a>随笔和正文</h3><p>目前为止，我们确认了两个指导方针</p>
<ul>
<li>博客要常写，否则会手生</li>
<li>常写的博客成本不能太高，必须与价值均衡</li>
</ul>
<p>这为随笔出现在我的博客列表中提供了正当性。按照过去一年的经验，要想完成一篇知识涵盖相对完整、有稍许深度的博文，往往需要好几个工作日的下班时间来搜集资料，再花一整天时间进行资料整理、知识点提炼和总结，最后再花半天时间进行文本校对、版式重排等。可以说相当耗时。</p>
<p>比如《可能是最全的Kotlin协程讲解》这篇文章零零总总耗费了一周的业余时间查阅整理资料，一整个周六的时间提炼和编写；《PostgreSQL - 一文看懂explain》花费了一周时间看完了整本书，再花费了两天时间整理和编写。</p>
<p>如上列举的两篇文章，我们称之为正文，成本非常高，当然不能作为常写的目标，毕竟我还需要学习和工作。于是我需要随笔的加入。</p>
<p>我这样定义随笔：日常学习中的某些知识点提取出来的，有一定分享价值的短篇文章。不会过于随便，又不会过于耗时。非常适合用来预热。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>写了一个小时，总结就是，<strong>我要些随笔了</strong>。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zou8944.com/PostgreSQL%20-%20%E4%B8%80%E6%96%87%E7%9C%8B%E6%87%82explain-postgresql-yi-wen-kan-dong-explain/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="果冻 | Jelly">
      <meta itemprop="description" content="Beat Jelly; Hit Jelly; Kill Jelly.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="果冻 | Jelly">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/PostgreSQL%20-%20%E4%B8%80%E6%96%87%E7%9C%8B%E6%87%82explain-postgresql-yi-wen-kan-dong-explain/" class="post-title-link" itemprop="url">PostgreSQL - 一文看懂explain</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-08-01 23:34:17" itemprop="dateCreated datePublished" datetime="2020-08-01T23:34:17+08:00">2020-08-01</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-02-16 23:36:37" itemprop="dateModified" datetime="2021-02-16T23:36:37+08:00">2021-02-16</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%90%8E%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">后端</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>explain是SQL优化的前提。但explain的结果，无论是官方手册，还是别人写的博客，看完后点头如捣蒜，但往往看到自己SQL的执行计划时，并不很确定要优化的点在哪里。很大一部分原因是不知道各计划节点的具体含义，更确切地说，是不明白SQL执行的原理。比如，我们并不能很好地回答以下问题</p>
<ul>
<li>index scan、index only scan、bitmap index scan 有啥区别？</li>
<li>为什么明明有建立索引，但PG就是不用呢？</li>
<li>执行计划中有子查询就一定不好吗？</li>
<li>hash join、merge join、nestloop join有啥区别？</li>
<li>。。。。。。</li>
</ul>
<p>本文的目的，是让大家看懂SQL执行计划。毕竟，看懂了，才谈得上优化。</p>
</blockquote>
<p>只有在了解数据库针对SQL做了哪些优化，才能制定出合理策略，利用优化器本身的特性达到最终优化整个SQL的最终目的，因此我们首先会介绍SQL优化器的原理；而本文的目的是让大家看懂explain，因此会介绍执行计划中最核心的部分——扫描节点和连接节点，大部分的优化思路都来自于此；文章的最后介绍explain命令得到的结果每一部分的具体含义，并介绍方便查看复杂计划的可视化工具。</p>
<h2 id="查询优化器原理"><a href="#查询优化器原理" class="headerlink" title="查询优化器原理"></a>查询优化器原理</h2><p>在介绍执行计划前，先了解一下执行计划生成的原理。一条SQL从输入到执行完毕，大致会经历如下三个步骤</p>
<ol>
<li>语法分析：词法分析、语法分析、语义分析</li>
<li><strong>查询优化：基于规则的优化、基于代价的优化</strong></li>
<li>查询执行、数据存取</li>
</ol>
<p>explain的输出，是查询优化的最终结果。而查询优化又被分为两个步骤</p>
<ul>
<li><p>基于规则的优化：即逻辑优化，通过对关系代数表达式进行逻辑上的等价变换，以获得性能更好的计划，比如谓词下推（将上层的过滤条件下推到下层）。</p>
</li>
<li><p>基于代价的优化：即物理优化，逻辑优化后，实际的查询路径还是有很多种，PG建立了代价计算模型，计算所有可能路径的代价，选出最优路径。</p>
<p>比如<code>select * from users where id = 1</code>，在扫描方式上，有顺序扫描、索引扫描等。在不同的数据量情况下，按顺序扫描和索引扫描的代价可能是不一样的，因此它的执行计划可能会随数据量的变化而变化。</p>
</li>
</ul>
<h3 id="逻辑优化（基于规则的优化）"><a href="#逻辑优化（基于规则的优化）" class="headerlink" title="逻辑优化（基于规则的优化）"></a>逻辑优化（基于规则的优化）</h3><p>基于逻辑的等价变换，可对原始的SQL语句进行优化。逻辑优化的基本原则——将复杂逻辑变为简单逻辑。具体做的工作，大致是提升子查询、表达式预处理、having子句条件下推、group by冗余字段消除、谓词（过滤条件）下推、外连接消除等。</p>
<h4 id="子查询提升"><a href="#子查询提升" class="headerlink" title="子查询提升"></a>子查询提升</h4><p>子查询可分为如下两类</p>
<ul>
<li><p>相关子查询：子查询中引用外层表的列属性，导致外层表的每一条记录，子查询都需要重新执行一次</p>
</li>
<li><p>非相关子查询：子查询是独立的，与外层表没有直接的关联，子查询单独执行一次，外层表可以重复利用其结果</p>
</li>
</ul>
<p>通常来说，相关子查询会被提升，非相关子查询由于其本来就只执行一次，因此没有太大必要提升。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 相关子查询举例</span></span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span>, (<span class="keyword">select</span> label_id <span class="keyword">from</span> content_to_label <span class="keyword">where</span> content_id <span class="operator">=</span> content.id) <span class="keyword">as</span> label_id <span class="keyword">from</span> content;</span><br><span class="line">HotSpotIntrinsicCandidate</span><br><span class="line">Seq Scan <span class="keyword">on</span> content  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.3694</span><span class="number">.61</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1151</span> width<span class="operator">=</span><span class="number">743</span>)</span><br><span class="line">  SubPlan <span class="number">1</span></span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>  Seq Scan <span class="keyword">on</span> content_to_label  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.3</span><span class="number">.10</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">3</span> width<span class="operator">=</span><span class="number">4</span>)</span><br><span class="line">          <span class="keyword">Filter</span>: (content_id <span class="operator">=</span> content.id)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 非相关子查询举例</span></span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span>, (<span class="keyword">select</span> label_id <span class="keyword">from</span> content_to_label limit <span class="number">1</span>) <span class="keyword">as</span> label_id <span class="keyword">from</span> content;</span><br><span class="line"></span><br><span class="line">Seq Scan <span class="keyword">on</span> content  (cost<span class="operator">=</span><span class="number">0.02</span>.<span class="number">.126</span><span class="number">.53</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1151</span> width<span class="operator">=</span><span class="number">743</span>)</span><br><span class="line">  InitPlan <span class="number">1</span> (<span class="keyword">returns</span> $<span class="number">0</span>)</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>  Limit  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.0</span><span class="number">.02</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1</span> width<span class="operator">=</span><span class="number">4</span>)</span><br><span class="line">          <span class="operator">-</span><span class="operator">&gt;</span>  Seq Scan <span class="keyword">on</span> content_to_label  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.2</span><span class="number">.68</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">168</span> width<span class="operator">=</span><span class="number">4</span>)</span><br></pre></td></tr></table></figure>

<p>相关子查询又可以依据子查询出现的位置分为如下两种——子查询和子连接，他们都能够被提升。</p>
<ul>
<li><p>子查询语句：出现在FROM关键字后的是子查询语句</p>
</li>
<li><p>子连接语句：出现在WHERE/ON等约束条件或SELECT子句中的是子连接语句</p>
</li>
</ul>
<p><strong>提升子连接</strong></p>
<p>子连接是子查询的一种特殊情况，由于它常出现在条件中，因此通常伴随ANY、EXISTS、NOT EXISTS、IN、NOT IN等关键字，PG会对他们尝试做提升，比如</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查询那些打过标签的文章</span></span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> content <span class="keyword">where</span> <span class="keyword">exists</span>(<span class="keyword">select</span> <span class="number">1</span> <span class="keyword">from</span> content_to_label <span class="keyword">where</span> content_id <span class="operator">=</span> content.id);</span><br><span class="line"><span class="comment">-- 在不优化的情况下，exists子查询会像上面所示，真的是子查询。但这里优化器将子查询做了提升，提升后变成连接，通过将内表hash化，降低算法复杂度</span></span><br><span class="line">Hash <span class="keyword">Join</span>  (cost<span class="operator">=</span><span class="number">4.43</span>.<span class="number">.134</span><span class="number">.62</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">59</span> width<span class="operator">=</span><span class="number">739</span>)</span><br><span class="line">  Hash Cond: (content.id <span class="operator">=</span> content_to_label.content_id)</span><br><span class="line">  <span class="operator">-</span><span class="operator">&gt;</span>  Seq Scan <span class="keyword">on</span> content  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.126</span><span class="number">.51</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1151</span> width<span class="operator">=</span><span class="number">739</span>)</span><br><span class="line">  <span class="operator">-</span><span class="operator">&gt;</span>  Hash  (cost<span class="operator">=</span><span class="number">3.69</span>.<span class="number">.3</span><span class="number">.69</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">59</span> width<span class="operator">=</span><span class="number">4</span>)</span><br><span class="line">        <span class="operator">-</span><span class="operator">&gt;</span>  HashAggregate  (cost<span class="operator">=</span><span class="number">3.10</span>.<span class="number">.3</span><span class="number">.69</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">59</span> width<span class="operator">=</span><span class="number">4</span>)</span><br><span class="line">              <span class="keyword">Group</span> Key: content_to_label.content_id</span><br><span class="line">              <span class="operator">-</span><span class="operator">&gt;</span>  Seq Scan <span class="keyword">on</span> content_to_label  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.2</span><span class="number">.68</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">168</span> width<span class="operator">=</span><span class="number">4</span>)</span><br></pre></td></tr></table></figure>

<p>能够被提升还有一个前提条件是子查询必须足够简单，上面同样的SQL，子查询投影改成聚集函数，就无法提升</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> content <span class="keyword">where</span> <span class="keyword">exists</span>(<span class="keyword">select</span> <span class="built_in">sum</span>(content_id) <span class="keyword">from</span> content_to_label <span class="keyword">where</span> content_id <span class="operator">=</span> content.id);</span><br><span class="line"></span><br><span class="line">Seq Scan <span class="keyword">on</span> content  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.3714</span><span class="number">.75</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">576</span> width<span class="operator">=</span><span class="number">739</span>)</span><br><span class="line">  <span class="keyword">Filter</span>: (SubPlan <span class="number">1</span>)</span><br><span class="line">  SubPlan <span class="number">1</span></span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>  Aggregate  (cost<span class="operator">=</span><span class="number">3.11</span>.<span class="number">.3</span><span class="number">.12</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1</span> width<span class="operator">=</span><span class="number">8</span>)</span><br><span class="line">          <span class="operator">-</span><span class="operator">&gt;</span>  Seq Scan <span class="keyword">on</span> content_to_label  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.3</span><span class="number">.10</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">3</span> width<span class="operator">=</span><span class="number">4</span>)</span><br><span class="line">                <span class="keyword">Filter</span>: (content_id <span class="operator">=</span> content.id)</span><br></pre></td></tr></table></figure>

<p><strong>提升子查询</strong></p>
<p>出现在表位置的子查询，也能够提升，如下</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> content <span class="keyword">left</span> <span class="keyword">join</span> (<span class="keyword">select</span> <span class="operator">*</span>, <span class="number">1</span> <span class="keyword">from</span> content_to_label) ctl <span class="keyword">on</span> content.id <span class="operator">=</span> ctl.content_id;</span><br><span class="line"></span><br><span class="line">Hash <span class="keyword">Right</span> <span class="keyword">Join</span>  (cost<span class="operator">=</span><span class="number">140.90</span>.<span class="number">.144</span><span class="number">.02</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1151</span> width<span class="operator">=</span><span class="number">759</span>)</span><br><span class="line">  Hash Cond: (content_to_label.content_id <span class="operator">=</span> content.id)</span><br><span class="line">  <span class="operator">-</span><span class="operator">&gt;</span>  Seq Scan <span class="keyword">on</span> content_to_label  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.2</span><span class="number">.68</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">168</span> width<span class="operator">=</span><span class="number">20</span>)</span><br><span class="line">  <span class="operator">-</span><span class="operator">&gt;</span>  Hash  (cost<span class="operator">=</span><span class="number">126.51</span>.<span class="number">.126</span><span class="number">.51</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1151</span> width<span class="operator">=</span><span class="number">739</span>)</span><br><span class="line">        <span class="operator">-</span><span class="operator">&gt;</span>  Seq Scan <span class="keyword">on</span> content  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.126</span><span class="number">.51</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1151</span> width<span class="operator">=</span><span class="number">739</span>)</span><br></pre></td></tr></table></figure>

<h4 id="预处理表达式"><a href="#预处理表达式" class="headerlink" title="预处理表达式"></a>预处理表达式</h4><p>即将能够事先处理的表达式处理掉，比如常量结算、约束条件的逻辑简化等</p>
<ul>
<li><p>常量简化</p>
<p>即直接计算出SQL中的常量表达式</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 可以直接计算出101</span></span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> content <span class="keyword">where</span> id <span class="operator">&lt;</span> <span class="number">1</span> <span class="operator">+</span> <span class="number">100</span></span><br><span class="line"></span><br><span class="line">Bitmap Heap Scan <span class="keyword">on</span> content  (cost<span class="operator">=</span><span class="number">5.08</span>.<span class="number">.123</span><span class="number">.47</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">104</span> width<span class="operator">=</span><span class="number">739</span>)</span><br><span class="line">  Recheck Cond: (id <span class="operator">&lt;</span> <span class="number">101</span>)</span><br><span class="line">  <span class="operator">-</span><span class="operator">&gt;</span>  Bitmap Index Scan <span class="keyword">on</span> content_pkey  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.5</span><span class="number">.06</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">104</span> width<span class="operator">=</span><span class="number">0</span>)</span><br><span class="line">        Index Cond: (id <span class="operator">&lt;</span> <span class="number">101</span>)</span><br></pre></td></tr></table></figure></li>
<li><p>谓词规范化（规约、拉平、提取公共项）</p>
<p>对无用的约束条件去除</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- false对于或运算是没用的，会被优化器直接去除</span></span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> content <span class="keyword">where</span> id <span class="operator">&lt;</span> <span class="number">100</span> <span class="keyword">or</span> <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">Bitmap Heap Scan <span class="keyword">on</span> content  (cost<span class="operator">=</span><span class="number">5.08</span>.<span class="number">.123</span><span class="number">.45</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">103</span> width<span class="operator">=</span><span class="number">739</span>)</span><br><span class="line">  Recheck Cond: (id <span class="operator">&lt;</span> <span class="number">100</span>)</span><br><span class="line">  <span class="operator">-</span><span class="operator">&gt;</span>  Bitmap Index Scan <span class="keyword">on</span> content_pkey  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.5</span><span class="number">.05</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">103</span> width<span class="operator">=</span><span class="number">0</span>)</span><br><span class="line">        Index Cond: (id <span class="operator">&lt;</span> <span class="number">100</span>)</span><br></pre></td></tr></table></figure>

<p>约束条件会被拉平</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 约束条件进行了无谓的括号，会被拉平</span></span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> content <span class="keyword">where</span> id <span class="operator">&lt;</span> <span class="number">100</span> <span class="keyword">or</span> (id <span class="operator">&lt;</span> <span class="number">1000</span> <span class="keyword">or</span> id <span class="operator">&gt;</span> <span class="number">2000</span>)</span><br><span class="line"></span><br><span class="line">Seq Scan <span class="keyword">on</span> content  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.135</span><span class="number">.14</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">978</span> width<span class="operator">=</span><span class="number">739</span>)</span><br><span class="line">  <span class="keyword">Filter</span>: ((id <span class="operator">&lt;</span> <span class="number">100</span>) <span class="keyword">OR</span> (id <span class="operator">&lt;</span> <span class="number">1000</span>) <span class="keyword">OR</span> (id <span class="operator">&gt;</span> <span class="number">2000</span>))</span><br></pre></td></tr></table></figure>

<p>约束条件经过逻辑运算后，会被提取公共项</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 约束条件提取公共项，只剩下id &gt; 1 and id &lt; 2</span></span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> content <span class="keyword">where</span> (id <span class="operator">&gt;</span> <span class="number">1</span> <span class="keyword">and</span> id <span class="operator">&lt;</span> <span class="number">2</span> <span class="keyword">and</span> id <span class="operator">&lt;</span> <span class="number">100</span>) <span class="keyword">or</span> (id <span class="operator">&gt;</span> <span class="number">1</span> <span class="keyword">and</span> id <span class="operator">&lt;</span> <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">Index Scan <span class="keyword">using</span> content_pkey <span class="keyword">on</span> content  (cost<span class="operator">=</span><span class="number">0.28</span>.<span class="number">.8</span><span class="number">.30</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1</span> width<span class="operator">=</span><span class="number">739</span>)</span><br><span class="line">  Index Cond: ((id <span class="operator">&gt;</span> <span class="number">1</span>) <span class="keyword">AND</span> (id <span class="operator">&lt;</span> <span class="number">2</span>))</span><br></pre></td></tr></table></figure></li>
</ul>
<h4 id="处理HAVING子句"><a href="#处理HAVING子句" class="headerlink" title="处理HAVING子句"></a>处理HAVING子句</h4><p>HAVING子句的优化主要是将部分条件转变为普通的过滤条件，从而减少原始数据的大小。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 统计发过发过10篇以上内容且用户id&gt;10的用户</span></span><br><span class="line">explain <span class="keyword">select</span> &quot;authorId&quot; <span class="keyword">from</span> content <span class="keyword">group</span> <span class="keyword">by</span> &quot;authorId&quot; <span class="keyword">having</span> <span class="built_in">count</span>(<span class="number">1</span>) <span class="operator">&gt;</span> <span class="number">10</span> <span class="keyword">and</span> &quot;authorId&quot; <span class="operator">&gt;</span> <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">HashAggregate  (cost<span class="operator">=</span><span class="number">132.85</span>.<span class="number">.133</span><span class="number">.50</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">65</span> width<span class="operator">=</span><span class="number">4</span>)</span><br><span class="line">  <span class="keyword">Group</span> Key: &quot;authorId&quot;</span><br><span class="line">  <span class="keyword">Filter</span>: (<span class="built_in">count</span>(<span class="number">1</span>) <span class="operator">&gt;</span> <span class="number">10</span>)</span><br><span class="line">  <span class="operator">-</span><span class="operator">&gt;</span>  Seq Scan <span class="keyword">on</span> content  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.129</span><span class="number">.39</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">692</span> width<span class="operator">=</span><span class="number">4</span>)</span><br><span class="line">        <span class="keyword">Filter</span>: (&quot;authorId&quot; <span class="operator">&gt;</span> <span class="number">100</span>)</span><br></pre></td></tr></table></figure>

<h4 id="GroupBy键值消除"><a href="#GroupBy键值消除" class="headerlink" title="GroupBy键值消除"></a>GroupBy键值消除</h4><p>GroupBy子句需要借助排序或哈希实现，如果能减少它后面的字段，就能降低损耗。典型的是如果group by中出现了一个主键和多个不相关的字段，则仅保留主键即可，因为主键唯一不可重复，没有必要再对其他字段进行排序或hash操作了</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> content <span class="keyword">group</span> <span class="keyword">by</span> id, type, &quot;authorId&quot;;</span><br><span class="line"></span><br><span class="line">HashAggregate  (cost<span class="operator">=</span><span class="number">129.39</span>.<span class="number">.140</span><span class="number">.90</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1151</span> width<span class="operator">=</span><span class="number">739</span>)</span><br><span class="line">  <span class="keyword">Group</span> Key: id</span><br><span class="line">  <span class="operator">-</span><span class="operator">&gt;</span>  Seq Scan <span class="keyword">on</span> content  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.126</span><span class="number">.51</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1151</span> width<span class="operator">=</span><span class="number">739</span>)</span><br></pre></td></tr></table></figure>

<h4 id="谓词下推"><a href="#谓词下推" class="headerlink" title="谓词下推"></a>谓词下推</h4><p>谓词即筛选条件，将上层的条件下推到基层进行扫描，会带来性能上的提升。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 过滤条件下推</span></span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> content <span class="keyword">left</span> <span class="keyword">join</span> content_to_label ctl <span class="keyword">on</span> content.id <span class="operator">=</span> ctl.content_id <span class="keyword">where</span> content.id <span class="operator">&lt;</span> <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">Hash <span class="keyword">Right</span> <span class="keyword">Join</span>  (cost<span class="operator">=</span><span class="number">125.48</span>.<span class="number">.128</span><span class="number">.60</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">103</span> width<span class="operator">=</span><span class="number">755</span>)</span><br><span class="line">  Hash Cond: (ctl.content_id <span class="operator">=</span> content.id)</span><br><span class="line">  <span class="operator">-</span><span class="operator">&gt;</span>  Seq Scan <span class="keyword">on</span> content_to_label ctl  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.2</span><span class="number">.68</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">168</span> width<span class="operator">=</span><span class="number">16</span>)</span><br><span class="line">  <span class="operator">-</span><span class="operator">&gt;</span>  Hash  (cost<span class="operator">=</span><span class="number">124.19</span>.<span class="number">.124</span><span class="number">.19</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">103</span> width<span class="operator">=</span><span class="number">739</span>)</span><br><span class="line">        <span class="operator">-</span><span class="operator">&gt;</span>  Bitmap Heap Scan <span class="keyword">on</span> content  (cost<span class="operator">=</span><span class="number">5.08</span>.<span class="number">.124</span><span class="number">.19</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">103</span> width<span class="operator">=</span><span class="number">739</span>)</span><br><span class="line">              Recheck Cond: (id <span class="operator">&lt;</span> <span class="number">100</span>)</span><br><span class="line">              <span class="operator">-</span><span class="operator">&gt;</span>  Bitmap Index Scan <span class="keyword">on</span> content_pkey  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.5</span><span class="number">.05</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">103</span> width<span class="operator">=</span><span class="number">0</span>)</span><br><span class="line">                    Index Cond: (id <span class="operator">&lt;</span> <span class="number">100</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 连接条件下推</span></span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> content <span class="keyword">left</span> <span class="keyword">join</span> content_to_label ctl <span class="keyword">on</span> ctl.content_id <span class="operator">&lt;</span> <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">Nested Loop <span class="keyword">Left</span> <span class="keyword">Join</span>  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.145</span><span class="number">.23</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1161</span> width<span class="operator">=</span><span class="number">755</span>)</span><br><span class="line">  <span class="operator">-</span><span class="operator">&gt;</span>  Seq Scan <span class="keyword">on</span> content  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.127</span><span class="number">.61</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1161</span> width<span class="operator">=</span><span class="number">739</span>)</span><br><span class="line">  <span class="operator">-</span><span class="operator">&gt;</span>  Materialize  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.3</span><span class="number">.10</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1</span> width<span class="operator">=</span><span class="number">16</span>)</span><br><span class="line">        <span class="operator">-</span><span class="operator">&gt;</span>  Seq Scan <span class="keyword">on</span> content_to_label ctl  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.3</span><span class="number">.10</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1</span> width<span class="operator">=</span><span class="number">16</span>)</span><br><span class="line">              <span class="keyword">Filter</span>: (content_id <span class="operator">&lt;</span> <span class="number">100</span>)</span><br></pre></td></tr></table></figure>

<h4 id="外连接消除"><a href="#外连接消除" class="headerlink" title="外连接消除"></a>外连接消除</h4><p>如果两个表是内连接，则他们之间的顺序可以任意交换，会方便谓词下推。而对于外连接，则不会那么方便。如果能够将外连接转换为内连接，则查询过程会简化。能够被转换为内连接的情况如下</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 常规左外连接</span></span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> content <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> content_to_label ctl <span class="keyword">on</span> content.id <span class="operator">=</span> ctl.content_id;</span><br><span class="line"></span><br><span class="line">Hash <span class="keyword">Right</span> <span class="keyword">Join</span>  (cost<span class="operator">=</span><span class="number">140.90</span>.<span class="number">.144</span><span class="number">.02</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1151</span> width<span class="operator">=</span><span class="number">755</span>)</span><br><span class="line">  Hash Cond: (ctl.content_id <span class="operator">=</span> content.id)</span><br><span class="line">  <span class="operator">-</span><span class="operator">&gt;</span>  Seq Scan <span class="keyword">on</span> content_to_label ctl  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.2</span><span class="number">.68</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">168</span> width<span class="operator">=</span><span class="number">16</span>)</span><br><span class="line">  <span class="operator">-</span><span class="operator">&gt;</span>  Hash  (cost<span class="operator">=</span><span class="number">126.51</span>.<span class="number">.126</span><span class="number">.51</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1151</span> width<span class="operator">=</span><span class="number">739</span>)</span><br><span class="line">        <span class="operator">-</span><span class="operator">&gt;</span>  Seq Scan <span class="keyword">on</span> content  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.126</span><span class="number">.51</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1151</span> width<span class="operator">=</span><span class="number">739</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 做左外连接，条件上限制可空侧的表格，消除外连接</span></span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> content <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> content_to_label ctl <span class="keyword">on</span> content.id <span class="operator">=</span> ctl.content_id <span class="keyword">where</span> ctl.content_id <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">Hash <span class="keyword">Join</span>  (cost<span class="operator">=</span><span class="number">140.90</span>.<span class="number">.144</span><span class="number">.02</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">168</span> width<span class="operator">=</span><span class="number">755</span>)</span><br><span class="line">  Hash Cond: (ctl.content_id <span class="operator">=</span> content.id)</span><br><span class="line">  <span class="operator">-</span><span class="operator">&gt;</span>  Seq Scan <span class="keyword">on</span> content_to_label ctl  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.2</span><span class="number">.68</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">168</span> width<span class="operator">=</span><span class="number">16</span>)</span><br><span class="line">        <span class="keyword">Filter</span>: (content_id <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>)</span><br><span class="line">  <span class="operator">-</span><span class="operator">&gt;</span>  Hash  (cost<span class="operator">=</span><span class="number">126.51</span>.<span class="number">.126</span><span class="number">.51</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1151</span> width<span class="operator">=</span><span class="number">739</span>)</span><br><span class="line">        <span class="operator">-</span><span class="operator">&gt;</span>  Seq Scan <span class="keyword">on</span> content  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.126</span><span class="number">.51</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1151</span> width<span class="operator">=</span><span class="number">739</span>)</span><br></pre></td></tr></table></figure>

<h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p>逻辑优化的具体项目当然不止上面列举这几项，但从这几项中也能够看出逻辑优化的思路，即消除多余的逻辑操作，尽量从逻辑上降低实际查询时需要处理的数据量。同时我们也能够看到，子查询不一定不好，只要能够被合理提升、或是非关联子查询，对性能的影响不一定会很大；而你写的哪些看起来有些多余的部分，只要合理，也可能会被在逻辑优化中消除。</p>
<h3 id="物理优化（基于代价的优化）"><a href="#物理优化（基于代价的优化）" class="headerlink" title="物理优化（基于代价的优化）"></a>物理优化（基于代价的优化）</h3><p>逻辑优化后得到新的查询树，PG会针对查询树生成各种不同的查询路径，并通过查询代价模型计算比较并得出查询代价最低的路径作为最终的查询计划。</p>
<h4 id="cost计算模型"><a href="#cost计算模型" class="headerlink" title="cost计算模型"></a>cost计算模型</h4><p>再数据库运行的实际环境中，用户的硬件环境天差地别，CPU频率、内存大小、磁盘介质等都会直接影响实际执行效率，因此代价估算无法十分准确。比较实际的是依据一套基本靠谱的模型，选出出各路径中代价相对最小的那一个作为最终结果。PG设定了一个相对单位1作为查询预估的最小单位，针对每种路径节点给与不同的单位数量，最终计算总代价的单位数量。</p>
<p>具体来说，代价计算要考虑的点主要如下</p>
<ul>
<li><p>IO基准代价</p>
<p>从磁盘中读取数据以page为单位，而顺序读取比随机读取省时。PG默认顺序读取一个页面的代价为1，随机读取一个页面的代价为4</p>
</li>
<li><p>CPU基准代价</p>
<ul>
<li>从页面中提取出具体的记录</li>
<li>对投影和约束条件中的表达式的计算成本</li>
</ul>
</li>
</ul>
<p>在PG中相关参数如下</p>
<ul>
<li>seq_page_cost：顺序扫描一个页面的IO成本，默认1.0</li>
<li>random_page_cost：随即扫描一个页面的IO成本，默认4.0</li>
<li>cpu_tuple_cost：获取一个元组（即记录）的CPU成本，默认0.01</li>
<li>cpu_index_tuple_cost：通过索引获取一个元组的CPU成本，默认0.005</li>
<li>cpu_operator_cost：执行一个表达式运算的CPU成本，默认0.0025</li>
<li>parallel_setup_cost：并行查询时进程间通讯的初始化成本，默认1000.0</li>
<li>parallel_tuple_cost：并行查询进行间投递元组的成本，默认0.1</li>
</ul>
<h4 id="选择率"><a href="#选择率" class="headerlink" title="选择率"></a>选择率</h4><p>pg_statistic表记录了各数据表字段的统计信息，比如表占据页面数量、表记录数量、字段null率、字段不重复记录的比率等内容，优化器会通过表的统计信息，根据SQL的筛选条件，得到针对该表的选择率（选中的记录数/总的记录数），选择率结合代价计算模型，得出最终的估算成本。</p>
<h4 id="小结-1"><a href="#小结-1" class="headerlink" title="小结"></a>小结</h4><p>成本估算是个非常复杂的工作，影响因素很多。于代价计算模型，除了那几个成本参数，还会考虑缓存对代价计算的影响，而缓存又有内存缓存和磁盘缓存；于选择率，由于统计表中的信息并不十分准确，随之造成选择率可能出现偏差，且针对联合投影的选择率计算又不一样，都会对最终查询路径的选择造成直接影响。因此尽管很多书籍和资料都有展示一个SQL的cost数字如何计算，但我认为实际的计算过程不应该轻易出现，一篇文章应有自己的定位，本文的目的是让大家看懂explain，而看懂explain只需要知道代价计算的原理，对各类扫描和计算成本的量级有基本的认识即可。没有强大的上下文介绍而直接上代价计算模型，对读者只会起到反作用（这是我看别人博客的切身感受）。</p>
<h2 id="查询树介绍"><a href="#查询树介绍" class="headerlink" title="查询树介绍"></a>查询树介绍</h2><p>查询优化器最终输出的计划，以树的形式体现，树节点主要有控制节点、扫描节点、连接节点等。其中，所有叶子节点都是扫描节点，执行器按照从低到高的顺序逐层执行。下图是根据本文最后一个示例（见下文）的执行计划所绘制：三个叶子节点分别是对comments、notification、content的顺序扫描，其中comments和content扫描后进行创建了hash表，notification扫描结果和content扫描的hash结果做hash连接，得到的结果再和comments扫描的hash结果做hash连接，完成最终的运算。</p>
<p><img src="https://img-blog.csdnimg.cn/20200801125412784.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3pvdTg5NDQ=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>下面介绍核心的三种扫描类型和三种连接类型</p>
<h3 id="扫描"><a href="#扫描" class="headerlink" title="扫描"></a>扫描</h3><ul>
<li><p>顺序扫描</p>
<p>即数据从头到尾扫描，适合连续的数据读取；不适合分布随机的数据。</p>
</li>
<li><p>索引扫描</p>
<ul>
<li><p>Index Scan</p>
<p>先扫描索引，再根据得到的key获取具体数据，涉及到随机读，因此如果索引扫描得到的数据量过大时，<strong>大量随机读也会带来很大的性能损失</strong>。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 通过索引获取少量数据</span></span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> content <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">Index Scan <span class="keyword">using</span> content_pkey <span class="keyword">on</span> content  (cost<span class="operator">=</span><span class="number">0.28</span>.<span class="number">.8</span><span class="number">.29</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1</span> width<span class="operator">=</span><span class="number">739</span>)</span><br><span class="line">  Index Cond: (id <span class="operator">=</span> <span class="number">100</span>)</span><br></pre></td></tr></table></figure></li>
<li><p>Index Only Scan</p>
<p>获取的目标字段就是索引的字段，因此仅扫描索引即可，即所谓的索引覆盖</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 直接获取索引的列</span></span><br><span class="line">explain <span class="keyword">select</span> id <span class="keyword">from</span> content <span class="keyword">where</span> id <span class="operator">=</span> <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">Index <span class="keyword">Only</span> Scan <span class="keyword">using</span> content_pkey <span class="keyword">on</span> content  (cost<span class="operator">=</span><span class="number">0.28</span>.<span class="number">.8</span><span class="number">.29</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1</span> width<span class="operator">=</span><span class="number">4</span>)</span><br><span class="line">  Index Cond: (id <span class="operator">=</span> <span class="number">100</span>)</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>位图扫描</p>
<p>针对Index Scan产生的随机读的优化，将索引读取到的key映射到位图，再扫描位图获取连续的key，将随机读变成连续读。出现位图扫描的地方一般会被分为两个步骤：索引映射到位图、通过位图扫描堆，即如下两个节点同时出现</p>
<ul>
<li>BitmapHeap Scan</li>
<li>BitmapIndex Scan</li>
</ul>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 通过索引获取较多数据</span></span><br><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> content <span class="keyword">where</span> id <span class="operator">&lt;</span> <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">Bitmap Heap Scan <span class="keyword">on</span> content  (cost<span class="operator">=</span><span class="number">5.08</span>.<span class="number">.124</span><span class="number">.19</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">103</span> width<span class="operator">=</span><span class="number">739</span>)</span><br><span class="line">  Recheck Cond: (id <span class="operator">&lt;</span> <span class="number">100</span>)</span><br><span class="line">  <span class="operator">-</span><span class="operator">&gt;</span>  Bitmap Index Scan <span class="keyword">on</span> content_pkey  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.5</span><span class="number">.05</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">103</span> width<span class="operator">=</span><span class="number">0</span>)</span><br><span class="line">        Index Cond: (id <span class="operator">&lt;</span> <span class="number">100</span>)</span><br></pre></td></tr></table></figure>

<p>上面的查询首先扫描索引，存储到位图（Bitmap Index），然后再通过位图扫描堆（Bitmap Head Scan），扫描时会再次检查条件（Recheck）</p>
</li>
<li><p>哪种扫描好</p>
<p>一般来说索引覆盖 &gt; 索引扫描 &gt; 索引+位图 &gt; 顺序扫描，但也并非绝对。如果优化器认为序列扫描的代价小于索引扫描，肯定是使用索引。比如同一个语句，根据条件范围的不同，也会选择不同的扫描方式。上面展示了id=100时使用索引扫描；id&lt;100时使用索引+位图扫描；这里展示id&gt;100时的结果</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 由于表中数据量超过500，这里的约束条件选择了绝大多数记录，因此使用顺序扫描会更划算（索引扫描带来的随机读抵消了它带来的优点）</span></span><br><span class="line">explain <span class="keyword">select</span> id <span class="keyword">from</span> content <span class="keyword">where</span> id <span class="operator">&gt;</span> <span class="number">100</span>;</span><br><span class="line"></span><br><span class="line">Seq Scan <span class="keyword">on</span> content  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.130</span><span class="number">.51</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1058</span> width<span class="operator">=</span><span class="number">4</span>)</span><br><span class="line">  <span class="keyword">Filter</span>: (id <span class="operator">&gt;</span> <span class="number">100</span>)</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="连接"><a href="#连接" class="headerlink" title="连接"></a>连接</h3><ul>
<li><p>Nestlooped Join</p>
<p>即最普通的连接，笛卡尔积，算法复杂度为O(MxN)，M和N是待连接表的记录数</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> content, content_to_label ctl;</span><br><span class="line"></span><br><span class="line">Nested Loop  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.2568</span><span class="number">.81</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">195048</span> width<span class="operator">=</span><span class="number">755</span>)</span><br><span class="line">  <span class="operator">-</span><span class="operator">&gt;</span>  Seq Scan <span class="keyword">on</span> content  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.127</span><span class="number">.61</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1161</span> width<span class="operator">=</span><span class="number">739</span>)</span><br><span class="line">  <span class="operator">-</span><span class="operator">&gt;</span>  Materialize  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.3</span><span class="number">.52</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">168</span> width<span class="operator">=</span><span class="number">16</span>)</span><br><span class="line">        <span class="operator">-</span><span class="operator">&gt;</span>  Seq Scan <span class="keyword">on</span> content_to_label ctl  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.2</span><span class="number">.68</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">168</span> width<span class="operator">=</span><span class="number">16</span>)</span><br></pre></td></tr></table></figure></li>
<li><p>Hash Join</p>
<p>对内表先提取一个hash表，对外表的每条记录，都通过hash很快地找到内表记录，从而加快连接速度。哈希连接复杂度为O(M+N)</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> content, content_to_label ctl <span class="keyword">where</span> content.id <span class="operator">=</span> ctl.content_id;</span><br><span class="line"></span><br><span class="line">Hash <span class="keyword">Join</span>  (cost<span class="operator">=</span><span class="number">142.12</span>.<span class="number">.145</span><span class="number">.24</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">168</span> width<span class="operator">=</span><span class="number">755</span>)</span><br><span class="line">  Hash Cond: (ctl.content_id <span class="operator">=</span> content.id)</span><br><span class="line">  <span class="operator">-</span><span class="operator">&gt;</span>  Seq Scan <span class="keyword">on</span> content_to_label ctl  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.2</span><span class="number">.68</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">168</span> width<span class="operator">=</span><span class="number">16</span>)</span><br><span class="line">  <span class="operator">-</span><span class="operator">&gt;</span>  Hash  (cost<span class="operator">=</span><span class="number">127.61</span>.<span class="number">.127</span><span class="number">.61</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1161</span> width<span class="operator">=</span><span class="number">739</span>)</span><br><span class="line">        <span class="operator">-</span><span class="operator">&gt;</span>  Seq Scan <span class="keyword">on</span> content  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.127</span><span class="number">.61</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1161</span> width<span class="operator">=</span><span class="number">739</span>)</span><br></pre></td></tr></table></figure>

<p>该计划将content当作内表，先顺序扫描，再提取hash（Hash），将content_to_label当作外表，最后进行哈希连接，连接时会检查连接条件</p>
</li>
<li><p>Merge Join</p>
<p>即归并连接，仅当两个候选表有序时才会使用归并连接。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> content <span class="keyword">order</span> <span class="keyword">by</span> id) content, (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> content_to_label <span class="keyword">order</span> <span class="keyword">by</span> content_id) ctl <span class="keyword">where</span> content.id <span class="operator">=</span> ctl.content_id <span class="keyword">order</span> <span class="keyword">by</span> ctl.content_id;</span><br><span class="line"></span><br><span class="line"><span class="keyword">Merge</span> <span class="keyword">Join</span>  (cost<span class="operator">=</span><span class="number">201.57</span>.<span class="number">.217</span><span class="number">.40</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">168</span> width<span class="operator">=</span><span class="number">755</span>)</span><br><span class="line">  <span class="keyword">Merge</span> Cond: (content.id <span class="operator">=</span> content_to_label.content_id)</span><br><span class="line">  <span class="operator">-</span><span class="operator">&gt;</span>  Sort  (cost<span class="operator">=</span><span class="number">186.71</span>.<span class="number">.189</span><span class="number">.61</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1161</span> width<span class="operator">=</span><span class="number">739</span>)</span><br><span class="line">        Sort Key: content.id</span><br><span class="line">        <span class="operator">-</span><span class="operator">&gt;</span>  Seq Scan <span class="keyword">on</span> content  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.127</span><span class="number">.61</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1161</span> width<span class="operator">=</span><span class="number">739</span>)</span><br><span class="line">  <span class="operator">-</span><span class="operator">&gt;</span>  Materialize  (cost<span class="operator">=</span><span class="number">8.89</span>.<span class="number">.11</span><span class="number">.41</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">168</span> width<span class="operator">=</span><span class="number">16</span>)</span><br><span class="line">        <span class="operator">-</span><span class="operator">&gt;</span>  Sort  (cost<span class="operator">=</span><span class="number">8.89</span>.<span class="number">.9</span><span class="number">.31</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">168</span> width<span class="operator">=</span><span class="number">16</span>)</span><br><span class="line">              Sort Key: content_to_label.content_id</span><br><span class="line">              <span class="operator">-</span><span class="operator">&gt;</span>  Seq Scan <span class="keyword">on</span> content_to_label  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.2</span><span class="number">.68</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">168</span> width<span class="operator">=</span><span class="number">16</span>)</span><br></pre></td></tr></table></figure>

<p>如上，先对两个备选表排序，然后将排序key作为连接条件，优化器选择了归并连接。</p>
</li>
<li><p>哪种连接好？</p>
<p>如果待连接表本来就有序，那Merge Join会更好，否则Hash Join好，出现NestLoop Join是绝对要避免的。</p>
</li>
</ul>
<h3 id="其它"><a href="#其它" class="headerlink" title="其它"></a>其它</h3><ul>
<li><p>Materialize</p>
<p>即物化，常出现在带有子查询的语句中，当子查询结果较少时，PG会将其存储起来，这也是提升性能的一种方式</p>
</li>
<li><p>CTE</p>
<p>通用表达式对应的是WITH语句，它的作用和子查询类似，但具有一次求值，多次使用的特点，并不会多次执行，因此一般不会被优化。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">with</span> contentt <span class="keyword">as</span> (<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> content) <span class="keyword">select</span> id <span class="keyword">from</span> contentt;</span><br><span class="line"></span><br><span class="line">CTE Scan <span class="keyword">on</span> contentt  (cost<span class="operator">=</span><span class="number">127.61</span>.<span class="number">.150</span><span class="number">.83</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1161</span> width<span class="operator">=</span><span class="number">4</span>)</span><br><span class="line">  CTE contentt</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>  Seq Scan <span class="keyword">on</span> content  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.127</span><span class="number">.61</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1161</span> width<span class="operator">=</span><span class="number">739</span>)</span><br></pre></td></tr></table></figure>

<p>SQL中存在CTE，其级别仅相当于执行一次的子查询。</p>
</li>
<li><p>Param</p>
<p>部分子查询的计划树中我们会看到<code>returns $0</code>这样的内容。其原理是：子查询每次执行结果都会返回并存储在一个Param中，父查询通过向Param传参启动子查询，如果发现之前同样的参数已经执行过了，则直接获取之前执行获得的结果，从而节省运行时间。即，Param具有缓存作用。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Seq Scan <span class="keyword">on</span> content  (cost<span class="operator">=</span><span class="number">0.02</span>.<span class="number">.126</span><span class="number">.53</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1151</span> width<span class="operator">=</span><span class="number">743</span>)</span><br><span class="line">  InitPlan <span class="number">1</span> (<span class="keyword">returns</span> $<span class="number">0</span>)</span><br><span class="line">    <span class="operator">-</span><span class="operator">&gt;</span>  Limit  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.0</span><span class="number">.02</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">1</span> width<span class="operator">=</span><span class="number">4</span>)</span><br><span class="line">          <span class="operator">-</span><span class="operator">&gt;</span>  Seq Scan <span class="keyword">on</span> content_to_label  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.2</span><span class="number">.68</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">168</span> width<span class="operator">=</span><span class="number">4</span>)</span><br></pre></td></tr></table></figure></li>
</ul>
<h3 id="小结-2"><a href="#小结-2" class="headerlink" title="小结"></a>小结</h3><p>执行计划的节点总类是非常多的，但核心的无非扫描和连接，再其次是子查询，这也是我们进行SQL优化重心所在：比如创建索引可以为优化器多提供一条选择路径；Nestloop Join出现时通常会带来较差的性能；子查询尽量优化为非相关的或连接操作。那遇到其他类型的节点怎么办？——当然是去查资料呀！</p>
<h2 id="Explain怎么看-直接看"><a href="#Explain怎么看-直接看" class="headerlink" title="Explain怎么看 - 直接看"></a>Explain怎么看 - 直接看</h2><p>通过<a target="_blank" rel="noopener" href="https://www.postgresql.org/docs/10/using-explain.html">explain命令</a>查看，常用explain + analyze同时查看计划成本和实际执行时间，注意analyze会导致SQL的确实执行。由于参数越多，出现的噪音越大，因此我的常用的习惯是先explain，再加上analyze查看具体情况。优化的思路是先找有没有一眼就看起来低效的节点，如Nestloop Join，无索引导致的Seq Scan等，其次重点关注cost耗费较多的节点。如下方性能损耗最大的是对content表的顺序扫描。</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">explain <span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> notification</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> content <span class="keyword">on</span> notification.target_content_id <span class="operator">=</span> content.id</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> comments <span class="keyword">on</span> notification.target_comment_id <span class="operator">=</span> comments.id</span><br><span class="line"><span class="keyword">where</span> (notification.target_content_id <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">and</span> content.state <span class="operator">=</span> <span class="string">&#x27;normal&#x27;</span>)</span><br><span class="line">   <span class="keyword">or</span> (notification.target_comment_id <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">null</span> <span class="keyword">and</span> comments.state <span class="operator">=</span> <span class="string">&#x27;normal&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- explain的命令执行结果如下：一棵树的文本输出形式</span></span><br><span class="line">Hash <span class="keyword">Left</span> <span class="keyword">Join</span>  (cost<span class="operator">=</span><span class="number">147.29</span>.<span class="number">.175</span><span class="number">.52</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">437</span> width<span class="operator">=</span><span class="number">928</span>)</span><br><span class="line">  Hash Cond: (notification.target_comment_id <span class="operator">=</span> comments.id)</span><br><span class="line">  <span class="operator">-</span><span class="operator">&gt;</span>  Hash <span class="keyword">Join</span>  (cost<span class="operator">=</span><span class="number">139.84</span>.<span class="number">.166</span><span class="number">.91</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">437</span> width<span class="operator">=</span><span class="number">855</span>)</span><br><span class="line">        Hash Cond: (notification.target_content_id <span class="operator">=</span> content.id)</span><br><span class="line">        <span class="operator">-</span><span class="operator">&gt;</span>  Seq Scan <span class="keyword">on</span> notification  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.25</span><span class="number">.22</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">701</span> width<span class="operator">=</span><span class="number">116</span>)</span><br><span class="line">              <span class="keyword">Filter</span>: (target_content_id <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>)</span><br><span class="line">        <span class="operator">-</span><span class="operator">&gt;</span>  Hash  (cost<span class="operator">=</span><span class="number">130.51</span>.<span class="number">.130</span><span class="number">.51</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">746</span> width<span class="operator">=</span><span class="number">739</span>)</span><br><span class="line">              <span class="operator">-</span><span class="operator">&gt;</span>  Seq Scan <span class="keyword">on</span> content  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.130</span><span class="number">.51</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">746</span> width<span class="operator">=</span><span class="number">739</span>)</span><br><span class="line">                    <span class="keyword">Filter</span>: (state <span class="operator">=</span> <span class="string">&#x27;normal&#x27;</span>::state_enum)</span><br><span class="line">  <span class="operator">-</span><span class="operator">&gt;</span>  Hash  (cost<span class="operator">=</span><span class="number">4.98</span>.<span class="number">.4</span><span class="number">.98</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">198</span> width<span class="operator">=</span><span class="number">73</span>)</span><br><span class="line">        <span class="operator">-</span><span class="operator">&gt;</span>  Seq Scan <span class="keyword">on</span> comments  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.4</span><span class="number">.98</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">198</span> width<span class="operator">=</span><span class="number">73</span>)</span><br></pre></td></tr></table></figure>

<p>配上解说的版本</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 左连接，连接方式为hash，（代价估计：开始-结束为149.58..178.62，预估结果行数530，宽度为928）</span></span><br><span class="line">Hash <span class="keyword">Left</span> <span class="keyword">Join</span>  (cost<span class="operator">=</span><span class="number">147.29</span>.<span class="number">.175</span><span class="number">.52</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">437</span> width<span class="operator">=</span><span class="number">928</span>)</span><br><span class="line"><span class="comment">-- 该层的连接条件</span></span><br><span class="line">  Hash Cond: (notification.target_comment_id <span class="operator">=</span> comments.id)</span><br><span class="line">  <span class="comment">-- 哈希连接</span></span><br><span class="line">  <span class="operator">-</span><span class="operator">&gt;</span>  Hash <span class="keyword">Join</span>  (cost<span class="operator">=</span><span class="number">139.84</span>.<span class="number">.166</span><span class="number">.91</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">437</span> width<span class="operator">=</span><span class="number">855</span>)</span><br><span class="line">  <span class="comment">--    该层的连接条件</span></span><br><span class="line">        Hash Cond: (notification.target_content_id <span class="operator">=</span> content.id)</span><br><span class="line">        <span class="comment">-- 对notification顺序奥妙</span></span><br><span class="line">        <span class="operator">-</span><span class="operator">&gt;</span>  Seq Scan <span class="keyword">on</span> notification  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.25</span><span class="number">.22</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">701</span> width<span class="operator">=</span><span class="number">116</span>)</span><br><span class="line">        <span class="comment">--    扫描条件为target_content_id不为null</span></span><br><span class="line">              <span class="keyword">Filter</span>: (target_content_id <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>)</span><br><span class="line">        <span class="comment">-- 对下层结果做hash</span></span><br><span class="line">        <span class="operator">-</span><span class="operator">&gt;</span>  Hash  (cost<span class="operator">=</span><span class="number">130.51</span>.<span class="number">.130</span><span class="number">.51</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">746</span> width<span class="operator">=</span><span class="number">739</span>)</span><br><span class="line">        	  <span class="comment">-- 顺序扫描content</span></span><br><span class="line">              <span class="operator">-</span><span class="operator">&gt;</span>  Seq Scan <span class="keyword">on</span> content  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.130</span><span class="number">.51</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">746</span> width<span class="operator">=</span><span class="number">739</span>)</span><br><span class="line">              <span class="comment">--    顺序扫描的过滤条件</span></span><br><span class="line">                    <span class="keyword">Filter</span>: (state <span class="operator">=</span> <span class="string">&#x27;normal&#x27;</span>::state_enum)</span><br><span class="line">  <span class="comment">-- 对下层结果做hash</span></span><br><span class="line">  <span class="operator">-</span><span class="operator">&gt;</span>  Hash  (cost<span class="operator">=</span><span class="number">4.98</span>.<span class="number">.4</span><span class="number">.98</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">198</span> width<span class="operator">=</span><span class="number">73</span>)</span><br><span class="line"> 		<span class="comment">-- 顺序扫描comments</span></span><br><span class="line">        <span class="operator">-</span><span class="operator">&gt;</span>  Seq Scan <span class="keyword">on</span> comments  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.4</span><span class="number">.98</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">198</span> width<span class="operator">=</span><span class="number">73</span>)</span><br></pre></td></tr></table></figure>

<p>加上analyze的版本，可以发现多了每个步骤实际执行的时间、各步骤的实际情况（如hash所生成的bucket数量、内存消耗等）</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Hash <span class="keyword">Left</span> <span class="keyword">Join</span>  (cost<span class="operator">=</span><span class="number">147.29</span>.<span class="number">.175</span><span class="number">.52</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">437</span> width<span class="operator">=</span><span class="number">928</span>) (actual <span class="type">time</span><span class="operator">=</span><span class="number">0.734</span>.<span class="number">.1</span><span class="number">.287</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">571</span> loops<span class="operator">=</span><span class="number">1</span>)</span><br><span class="line">  Hash Cond: (notification.target_comment_id <span class="operator">=</span> comments.id)</span><br><span class="line">  <span class="operator">-</span><span class="operator">&gt;</span>  Hash <span class="keyword">Join</span>  (cost<span class="operator">=</span><span class="number">139.84</span>.<span class="number">.166</span><span class="number">.91</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">437</span> width<span class="operator">=</span><span class="number">855</span>) (actual <span class="type">time</span><span class="operator">=</span><span class="number">0.626</span>.<span class="number">.0</span><span class="number">.999</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">571</span> loops<span class="operator">=</span><span class="number">1</span>)</span><br><span class="line">        Hash Cond: (notification.target_content_id <span class="operator">=</span> content.id)</span><br><span class="line">        <span class="operator">-</span><span class="operator">&gt;</span>  Seq Scan <span class="keyword">on</span> notification  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.25</span><span class="number">.22</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">701</span> width<span class="operator">=</span><span class="number">116</span>) (actual <span class="type">time</span><span class="operator">=</span><span class="number">0.009</span>.<span class="number">.0</span><span class="number">.159</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">727</span> loops<span class="operator">=</span><span class="number">1</span>)</span><br><span class="line">              <span class="keyword">Filter</span>: (target_content_id <span class="keyword">IS</span> <span class="keyword">NOT</span> <span class="keyword">NULL</span>)</span><br><span class="line">              <span class="keyword">Rows</span> Removed <span class="keyword">by</span> <span class="keyword">Filter</span>: <span class="number">21</span></span><br><span class="line">        <span class="operator">-</span><span class="operator">&gt;</span>  Hash  (cost<span class="operator">=</span><span class="number">130.51</span>.<span class="number">.130</span><span class="number">.51</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">746</span> width<span class="operator">=</span><span class="number">739</span>) (actual <span class="type">time</span><span class="operator">=</span><span class="number">0.609</span>.<span class="number">.0</span><span class="number">.609</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">732</span> loops<span class="operator">=</span><span class="number">1</span>)</span><br><span class="line">              Buckets: <span class="number">1024</span>  Batches: <span class="number">1</span>  Memory Usage: <span class="number">573</span>kB</span><br><span class="line">              <span class="operator">-</span><span class="operator">&gt;</span>  Seq Scan <span class="keyword">on</span> content  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.130</span><span class="number">.51</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">746</span> width<span class="operator">=</span><span class="number">739</span>) (actual <span class="type">time</span><span class="operator">=</span><span class="number">0.003</span>.<span class="number">.0</span><span class="number">.351</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">732</span> loops<span class="operator">=</span><span class="number">1</span>)</span><br><span class="line">                    <span class="keyword">Filter</span>: (state <span class="operator">=</span> <span class="string">&#x27;normal&#x27;</span>::state_enum)</span><br><span class="line">                    <span class="keyword">Rows</span> Removed <span class="keyword">by</span> <span class="keyword">Filter</span>: <span class="number">423</span></span><br><span class="line">  <span class="operator">-</span><span class="operator">&gt;</span>  Hash  (cost<span class="operator">=</span><span class="number">4.98</span>.<span class="number">.4</span><span class="number">.98</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">198</span> width<span class="operator">=</span><span class="number">73</span>) (actual <span class="type">time</span><span class="operator">=</span><span class="number">0.101</span>.<span class="number">.0</span><span class="number">.101</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">232</span> loops<span class="operator">=</span><span class="number">1</span>)</span><br><span class="line">        Buckets: <span class="number">1024</span>  Batches: <span class="number">1</span>  Memory Usage: <span class="number">31</span>kB</span><br><span class="line">        <span class="operator">-</span><span class="operator">&gt;</span>  Seq Scan <span class="keyword">on</span> comments  (cost<span class="operator">=</span><span class="number">0.00</span>.<span class="number">.4</span><span class="number">.98</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">198</span> width<span class="operator">=</span><span class="number">73</span>) (actual <span class="type">time</span><span class="operator">=</span><span class="number">0.003</span>.<span class="number">.0</span><span class="number">.034</span> <span class="keyword">rows</span><span class="operator">=</span><span class="number">232</span> loops<span class="operator">=</span><span class="number">1</span>)</span><br><span class="line">Planning <span class="type">time</span>: <span class="number">0.402</span> ms</span><br><span class="line">Execution <span class="type">time</span>: <span class="number">1.368</span> ms</span><br></pre></td></tr></table></figure>

<h2 id="Explain怎么看-可视化"><a href="#Explain怎么看-可视化" class="headerlink" title="Explain怎么看 - 可视化"></a>Explain怎么看 - 可视化</h2><p>pgAdmin提供了可视化explain的功能，支持将解释内容以图形的形式展示，使得更加方便地展示主干节点之间的关系和节点的意义，非常适合用来学习</p>
<p>比如同样描述上面的explain信息，图示如下<br><img src="https://img-blog.csdnimg.cn/20200801125451984.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3pvdTg5NDQ=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<p>pgAdmin4的使用方式，点击explain按钮即可<br><img src="https://img-blog.csdnimg.cn/20200801125514710.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3pvdTg5NDQ=,size_16,color_FFFFFF,t_70" alt="在这里插入图片描述"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本文简单介绍了PostgreSQL的查询优化器工作原理、执行计划核心节点的原理，以及explain输出结果该如何查看，并从自己的视角介绍了执行计划中需要关注的点。写本文之前，作者对执行计划的了解主要来自PG官方手册及网上零零散散的博文，总感觉不得要领。而为了完成本文，阅读了《Postgresql技术内幕——查询优化深度探索》全本、《PostgreSQL指南——内幕探索》查询优化章节、《数据库系统概念》连接概念部分，收获颇丰，算是初步系统地了解了查询优化的原理，回过头再看explain的执行计划，豁然开朗；而最令自己的惊喜的发现是《数据库系统概念》，该书作为经典书籍，对构建自身的数据库系统基础知识很有益处。由于作者文笔水平有限，表述不一定清晰准确，如读者有时间有精力，参考资料一栏文章和书籍，都是值得一读的。</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ol>
<li><a target="_blank" rel="noopener" href="https://www.postgresql.org/docs/10/using-explain.html">使用EXPLAIN </a></li>
<li><a target="_blank" rel="noopener" href="http://www.postgresonline.com/journal/archives/78-Why-is-my-index-not-being-used.html">为何我的索引没有被使用</a></li>
<li><a target="_blank" rel="noopener" href="http://mysql.taobao.org/monthly/2018/11/06/">EXPLAIN 使用浅析</a></li>
<li><a target="_blank" rel="noopener" href="http://www.postgres.cn/docs/9.4/catalog-pg-statistic.html">PG_STATISTIC</a></li>
<li>《数据库系统概念 - 第六版》（参考连接部分）</li>
<li>《PostgreSQL技术内幕——查询优化深度探索》</li>
<li>《PostgreSQL指南——内幕探索》</li>
<li><a target="_blank" rel="noopener" href="http://www.postgresonline.com/journal/archives/27-Reading-PgAdmin-Graphical-Explain-Plans.html">PGADMIN查看EXPLAIN结果</a></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zou8944.com/%E9%9A%8F%E7%AC%94%20-%20%E4%B8%BA%E4%BB%80%E4%B9%88%E6%88%91%E4%BB%AC%E4%BD%BF%E7%94%A8PostgreSQL%E8%80%8C%E4%B8%8D%E7%94%A8MySQL-sui-bi--wei-shen-me-wo-men-shi-yong-postgresql-er-bu-yong-mysql/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="果冻 | Jelly">
      <meta itemprop="description" content="Beat Jelly; Hit Jelly; Kill Jelly.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="果冻 | Jelly">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E9%9A%8F%E7%AC%94%20-%20%E4%B8%BA%E4%BB%80%E4%B9%88%E6%88%91%E4%BB%AC%E4%BD%BF%E7%94%A8PostgreSQL%E8%80%8C%E4%B8%8D%E7%94%A8MySQL-sui-bi--wei-shen-me-wo-men-shi-yong-postgresql-er-bu-yong-mysql/" class="post-title-link" itemprop="url">随笔 - 为什么我们使用PostgreSQL而不用MySQL</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-07-07 23:45:29" itemprop="dateCreated datePublished" datetime="2020-07-07T23:45:29+08:00">2020-07-07</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-02-16 23:45:53" itemprop="dateModified" datetime="2021-02-16T23:45:53+08:00">2021-02-16</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h2 id="与MySQL相比，有何优势"><a href="#与MySQL相比，有何优势" class="headerlink" title="与MySQL相比，有何优势"></a>与MySQL相比，有何优势</h2><ol>
<li><p>SQL标准的null判断用is null，而不是=null。PG可以设置transform_null_equals把=null翻译成is null</p>
</li>
<li><p>MySQL显示emojji时，需要将字符集设置为<a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/charset-unicode.html">utf8mb4</a>。而PG就不用</p>
<p>在MySQL中，对Unicode的支持，主要又如下几种字符集</p>
<ul>
<li>utf8mb4</li>
<li>utf8mb3</li>
<li>utf8</li>
<li>ucs2</li>
<li>utf16</li>
<li>utf16le</li>
<li>utf32</li>
</ul>
<p>这里我们只关心前三个，其中utf8mb4表示使用1-4字节来描述一个Unicode字符；utf8mb3表示使用1-3字节来描述一个Unicode字符。而utf8是utf8mb3的别名。</p>
<p>而Unicode字符分两种</p>
<ul>
<li><p>基本的BMP字符</p>
<p>码点位于U+0000 到 U+FFFF之间；能够使用1-3个字节变长表示；也能使用2字节定长表示；它之间包含了世界上的绝大多数语言。</p>
</li>
<li><p>BMP字符之外的附加字符</p>
<p>码点在U+10000 到 U+10FFFF之间；需要最多四个字节表示</p>
</li>
</ul>
<p>emojji字符也在unicode中，2010年Unicode开始为emojji分配码点。而它就在基础的BMP码点之外。因此utf8mb3是无法表示emojji字符的。</p>
<p>那PostgreSQL是如何做的呢？</p>
<p>依据<a target="_blank" rel="noopener" href="https://www.postgresql.org/docs/10/multibyte.html">手册</a>，PostgreSQL的text能够存各种类型的字符集，其中针对Unicode的UTF8，是1-4字节变长，因此PG天然就能存emojji字符。而PG服务端和客户端具体支持的其他字符集类型，还是参见手册。</p>
</li>
</ol>
<h2 id="与其他关系型数据库，有何优势"><a href="#与其他关系型数据库，有何优势" class="headerlink" title="与其他关系型数据库，有何优势"></a>与其他关系型数据库，有何优势</h2><ol>
<li>自带NoSQL属性：可以存储array和json，甚至可以在array和json上建立索引，他的jsonb的性能已经比MongoDB的BSON性能要好了。</li>
<li>自带全文搜索功能，不过中文的话就要额外安装中文分词插件。</li>
<li>他有GIS，即地理信息扩展，可以非常方便地进行地理位置计算，可做地图服务器。这是PG的杀手级功能。</li>
<li>能够高效地处理图结构。</li>
<li>能够当作时序数据库</li>
</ol>
<h2 id="结尾"><a href="#结尾" class="headerlink" title="结尾"></a>结尾</h2><p>PostgreSQL功能强大，基本日常用到的需求它都有了，并且做的都不错。它是一个全栈数据库。</p>
<p>国内比较有名的使用PG的公司是探探。百万日活、上百TB数据量，数据组件还只用了PG。直到千万日活才引入独立的数据仓库。</p>
<p><strong>OLTP</strong>：事务处理是PostgreSQL的本行</p>
<p><strong>OLAP</strong>：citus分布式插件，ANSI SQL兼容，窗口函数，CTE，CUBE等高级分析功能，任意语言写UDF</p>
<p><strong>流处理</strong>：PipelineDB扩展，Notify-Listen，物化视图，规则系统，灵活的存储过程与函数编写</p>
<p><strong>时序数据</strong>：timescaledb时序数据库插件，分区表，BRIN索引</p>
<p><strong>空间数据</strong>：PostGIS扩展（杀手锏），内建的几何类型支持，GiST索引。</p>
<p><strong>搜索索引</strong>：全文搜索索引足以应对简单场景；丰富的索引类型，支持函数索引，条件索引</p>
<p><strong>NoSQL</strong>：JSON，JSONB，XML，HStore原生支持，至NoSQL数据库的外部数据包装器</p>
<p><strong>数据仓库</strong>：能平滑迁移至同属Pg生态的GreenPlum，DeepGreen，HAWK等，使用FDW进行ETL</p>
<p><strong>图数据</strong>：递归查询</p>
<p><strong>缓存</strong>：物化视图</p>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><ol>
<li><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/refman/8.0/en/charset-unicode.html">MySQL手册</a></li>
<li><a target="_blank" rel="noopener" href="https://www.postgresql.org/docs/10/multibyte.html">PostgreSQL手册</a></li>
<li><a target="_blank" rel="noopener" href="http://www.postgres.cn/downfiles/pg2016conf_day1_s1_pm4.pdf">PostgreSQL和探探见证4亿次心动</a></li>
<li><a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/60027">https://developer.aliyun.com/article/60027</a></li>
</ol>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zou8944.com/Postgresql%E7%9A%84Listen-Notify%E6%9C%BA%E5%88%B6-postgresql%E7%9A%84listen-notify%E6%9C%BA%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="果冻 | Jelly">
      <meta itemprop="description" content="Beat Jelly; Hit Jelly; Kill Jelly.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="果冻 | Jelly">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Postgresql%E7%9A%84Listen-Notify%E6%9C%BA%E5%88%B6-postgresql%E7%9A%84listen-notify%E6%9C%BA%E5%88%B6/" class="post-title-link" itemprop="url">Postgresql的Listen-Notify机制</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-06-06 10:29:54" itemprop="dateCreated datePublished" datetime="2020-06-06T10:29:54+08:00">2020-06-06</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-02-16 23:21:09" itemprop="dateModified" datetime="2021-02-16T23:21:09+08:00">2021-02-16</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Postgresql提供 监听 - 通知 的订阅服务，使得数据库客户端向服务端的指定通道注册为监听客户端，服务端在发出Notify通知时，所有已注册的监听客户端将能够收到该通知。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/Postgresql%E7%9A%84Listen-Notify%E6%9C%BA%E5%88%B6-postgresql%E7%9A%84listen-notify%E6%9C%BA%E5%88%B6/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zou8944.com/Kotlin%E5%8D%8F%E7%A8%8B-%E4%BD%BF%E7%94%A8%E7%AF%87-kotlin%E5%8D%8F%E7%A8%8B-%E4%BD%BF%E7%94%A8%E7%AF%87md/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="果冻 | Jelly">
      <meta itemprop="description" content="Beat Jelly; Hit Jelly; Kill Jelly.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="果冻 | Jelly">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Kotlin%E5%8D%8F%E7%A8%8B-%E4%BD%BF%E7%94%A8%E7%AF%87-kotlin%E5%8D%8F%E7%A8%8B-%E4%BD%BF%E7%94%A8%E7%AF%87md/" class="post-title-link" itemprop="url">Kotlin协程-使用篇</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-05-25 22:57:26" itemprop="dateCreated datePublished" datetime="2020-05-25T22:57:26+08:00">2020-05-25</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-02-16 23:21:28" itemprop="dateModified" datetime="2021-02-16T23:21:28+08:00">2021-02-16</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%BC%96%E7%A8%8B%E8%AF%AD%E8%A8%80/" itemprop="url" rel="index"><span itemprop="name">编程语言</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <blockquote>
<p>使用协程已经有较长的时间了，但一直停留在launch、async启动协程，suspend方法挂起的阶段。这段时间系统梳理Kotlin知识时才发现，对协程（仅对Kotlin）还有很多概念不甚了解。例如CoroutineScope对协程生命周期的重要性、协程父子结构的作用、结构化并发、一些Kotlin协程中约定俗称的规定等。</p>
</blockquote>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/Kotlin%E5%8D%8F%E7%A8%8B-%E4%BD%BF%E7%94%A8%E7%AF%87-kotlin%E5%8D%8F%E7%A8%8B-%E4%BD%BF%E7%94%A8%E7%AF%87md/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zou8944.com/%E7%90%86%E8%A7%A3Java%20IO-%E7%90%86%E8%A7%A3javaio/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="果冻 | Jelly">
      <meta itemprop="description" content="Beat Jelly; Hit Jelly; Kill Jelly.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="果冻 | Jelly">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E7%90%86%E8%A7%A3Java%20IO-%E7%90%86%E8%A7%A3javaio/" class="post-title-link" itemprop="url">理解Java IO</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-04-19 12:34:51" itemprop="dateCreated datePublished" datetime="2020-04-19T12:34:51+08:00">2020-04-19</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-02-16 23:21:39" itemprop="dateModified" datetime="2021-02-16T23:21:39+08:00">2021-02-16</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%90%8E%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">后端</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>BIO、NIO、NIO2、AIO、Reactor、Proactor、EventLoop、Linux五种IO模型</p>
<p>上述术语和概念，相信大多数人都知道或部分知道，但都无法完整表达他们之间的意思，处于模棱两可的状态。我也不例外，而触发写这篇文章的契机，是有人问起我Vertx高性能的原因是什么时？我不假思索地回答NIO，因为在我的印象中，Vertx基于Netty实现，Netty又是对NIO的包装。但仔细想想，用NIO就能高性能吗？NIO和Vertx的EventLoop有什么关系呢？和Reactor又是什么关系呢？——我不禁开始思考人生。</p>
<p>下面就开始探索吧</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/%E7%90%86%E8%A7%A3Java%20IO-%E7%90%86%E8%A7%A3javaio/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zou8944.com/java%E6%97%B6%E9%97%B4%20-%20java.time%E4%BB%8B%E7%BB%8D-java%E6%97%B6%E9%97%B4-javatime%E4%BB%8B%E7%BB%8D/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="果冻 | Jelly">
      <meta itemprop="description" content="Beat Jelly; Hit Jelly; Kill Jelly.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="果冻 | Jelly">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/java%E6%97%B6%E9%97%B4%20-%20java.time%E4%BB%8B%E7%BB%8D-java%E6%97%B6%E9%97%B4-javatime%E4%BB%8B%E7%BB%8D/" class="post-title-link" itemprop="url">java时间 - java.time介绍</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-04-11 19:43:57" itemprop="dateCreated datePublished" datetime="2020-04-11T19:43:57+08:00">2020-04-11</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-02-16 23:21:53" itemprop="dateModified" datetime="2021-02-16T23:21:53+08:00">2021-02-16</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%90%8E%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">后端</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Java8中引入了新的库java.time，提供更为好用的日志API，从此不再在Date、Calendar这些类中纠结。本文基于<a target="_blank" rel="noopener" href="https://docs.oracle.com/javase/8/docs/api/java/time/package-summary.html">java.time API文档</a>进行记录和总结。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/java%E6%97%B6%E9%97%B4%20-%20java.time%E4%BB%8B%E7%BB%8D-java%E6%97%B6%E9%97%B4-javatime%E4%BB%8B%E7%BB%8D/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zou8944.com/Sign%20in%20with%20Apple%20-%20IOS%E5%B9%B3%E5%8F%B0%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%9A%84%E5%A4%84%E7%90%86-signinwithapple-ios%E5%B9%B3%E5%8F%B0%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%9A%84%E5%A4%84%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="果冻 | Jelly">
      <meta itemprop="description" content="Beat Jelly; Hit Jelly; Kill Jelly.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="果冻 | Jelly">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Sign%20in%20with%20Apple%20-%20IOS%E5%B9%B3%E5%8F%B0%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%9A%84%E5%A4%84%E7%90%86-signinwithapple-ios%E5%B9%B3%E5%8F%B0%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%9A%84%E5%A4%84%E7%90%86/" class="post-title-link" itemprop="url">Sign in with Apple - IOS平台服务端的处理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-03-28 20:41:32" itemprop="dateCreated datePublished" datetime="2020-03-28T20:41:32+08:00">2020-03-28</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-02-16 23:22:07" itemprop="dateModified" datetime="2021-02-16T23:22:07+08:00">2021-02-16</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E7%AC%AC%E4%B8%89%E6%96%B9%E7%99%BB%E5%BD%95/" itemprop="url" rel="index"><span itemprop="name">第三方登录</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <hr>
<p>title: Sign in with Apple - IOS平台服务端的处理<br>tags:</p>
<ul>
<li>IOS<br>categories:</li>
<li>第三方登录<br>date: 2020-03-28 20:41:32</li>
</ul>
<hr>
<p>本周新做一个需求，为IOS APP接入苹果第三方登录。查看官方文档，发现其在IOS端操作描述是非常细致的，但在用户服务端的讲解实在是不知所云，让人头大。只能借助广大网友的智慧。本文并非完全原创，因为无论概念解读，还是操作方式，都是从各个文章处抄来的。本文最大的作用，在于针对自己和团队内部的开发记录，防止多次踩坑。</p>
<p>Sign in with Apple，对IOS和其它平台的处理方式是有很大差别的。本文只针对IOS平台，其它平台可以参考<a target="_blank" rel="noopener" href="https://sarunw.com/posts/sign-in-with-apple-4/">这篇文章</a>，说得非常详细</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/Sign%20in%20with%20Apple%20-%20IOS%E5%B9%B3%E5%8F%B0%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%9A%84%E5%A4%84%E7%90%86-signinwithapple-ios%E5%B9%B3%E5%8F%B0%E6%9C%8D%E5%8A%A1%E7%AB%AF%E7%9A%84%E5%A4%84%E7%90%86/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zou8944.com/%E7%94%A8Prometheus%E5%92%8CGrafana%E7%9B%91%E6%8E%A7%E4%BD%A0%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%99%A8-%E7%94%A8prometheus%E5%92%8Cgrafana%E7%9B%91%E6%8E%A7%E4%BD%A0%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%99%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="果冻 | Jelly">
      <meta itemprop="description" content="Beat Jelly; Hit Jelly; Kill Jelly.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="果冻 | Jelly">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E7%94%A8Prometheus%E5%92%8CGrafana%E7%9B%91%E6%8E%A7%E4%BD%A0%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%99%A8-%E7%94%A8prometheus%E5%92%8Cgrafana%E7%9B%91%E6%8E%A7%E4%BD%A0%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%99%A8/" class="post-title-link" itemprop="url">用Prometheus和Grafana监控你的服务器</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-03-21 20:38:53" itemprop="dateCreated datePublished" datetime="2020-03-21T20:38:53+08:00">2020-03-21</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-02-16 23:22:16" itemprop="dateModified" datetime="2021-02-16T23:22:16+08:00">2021-02-16</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E8%BF%90%E7%BB%B4/" itemprop="url" rel="index"><span itemprop="name">运维</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>本文介绍使用Prometheus和Grafana搭建服务器监控的步骤，并简单介绍其中会涉及到的概念。</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/%E7%94%A8Prometheus%E5%92%8CGrafana%E7%9B%91%E6%8E%A7%E4%BD%A0%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%99%A8-%E7%94%A8prometheus%E5%92%8Cgrafana%E7%9B%91%E6%8E%A7%E4%BD%A0%E7%9A%84%E6%9C%8D%E5%8A%A1%E5%99%A8/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zou8944.com/%E9%82%A3%E4%BA%9B%E9%80%92%E5%BD%92%E7%9A%84%E8%AE%A1%E7%AE%97%E6%9C%BA%E6%9C%AF%E8%AF%AD-%E9%82%A3%E4%BA%9B%E9%80%92%E5%BD%92%E7%9A%84%E8%AE%A1%E7%AE%97%E6%9C%BA%E6%9C%AF%E8%AF%AD/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="果冻 | Jelly">
      <meta itemprop="description" content="Beat Jelly; Hit Jelly; Kill Jelly.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="果冻 | Jelly">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/%E9%82%A3%E4%BA%9B%E9%80%92%E5%BD%92%E7%9A%84%E8%AE%A1%E7%AE%97%E6%9C%BA%E6%9C%AF%E8%AF%AD-%E9%82%A3%E4%BA%9B%E9%80%92%E5%BD%92%E7%9A%84%E8%AE%A1%E7%AE%97%E6%9C%BA%E6%9C%AF%E8%AF%AD/" class="post-title-link" itemprop="url">那些递归的计算机术语</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-03-15 20:12:13" itemprop="dateCreated datePublished" datetime="2020-03-15T20:12:13+08:00">2020-03-15</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-02-16 23:22:30" itemprop="dateModified" datetime="2021-02-16T23:22:30+08:00">2021-02-16</time>
      </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>GNU<br>GNOME<br>GTK<br>CURL<br>WINE<br>YAML<br>RPM<br>BING<br>PNG</p>
<p>参考文档：<a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Recursive_acronym#cite_note-1">https://en.wikipedia.org/wiki/Recursive_acronym#cite_note-1</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="https://zou8944.com/Vert.x%20-%20Web%20API%20Contract%E7%9A%84%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86-vertx-webapicontract%E7%9A%84%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="果冻 | Jelly">
      <meta itemprop="description" content="Beat Jelly; Hit Jelly; Kill Jelly.">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="果冻 | Jelly">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/Vert.x%20-%20Web%20API%20Contract%E7%9A%84%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86-vertx-webapicontract%E7%9A%84%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/" class="post-title-link" itemprop="url">Vert.x - Web API Contract的错误处理</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">发表于</span>

      <time title="创建时间：2020-03-14 18:43:43" itemprop="dateCreated datePublished" datetime="2020-03-14T18:43:43+08:00">2020-03-14</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">更新于</span>
        <time title="修改时间：2021-02-16 23:22:42" itemprop="dateModified" datetime="2021-02-16T23:22:42+08:00">2021-02-16</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">分类于</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Vert-x/" itemprop="url" rel="index"><span itemprop="name">Vert.x</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Vert.x Web API Contract模块在Vert.x Web的基础上进行扩展，支持OpenAPI 3.0规范。</p>
<p>使用上有两种方式</p>
<ul>
<li><p>编程方式</p>
<p>预定义<code>HTTPRequestValidationHandler</code>，并在route中传入，就像<a target="_blank" rel="noopener" href="https://vertx.io/docs/vertx-web-api-contract/java/">手册给的那样</a></p>
</li>
<li><p>配置文件方式</p>
<p>预先定义好接口描述文件，通过<code>OpenAPI3RouterFactory</code>加载并挂载到Router上</p>
          <!--noindex-->
            <div class="post-button">
              <a class="btn" href="/Vert.x%20-%20Web%20API%20Contract%E7%9A%84%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86-vertx-webapicontract%E7%9A%84%E9%94%99%E8%AF%AF%E5%A4%84%E7%90%86/#more" rel="contents">
                阅读全文 &raquo;
              </a>
            </div>
          <!--/noindex-->
        
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">果冻 | Jelly</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a> 强力驱动
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  





  





</body>
</html>
