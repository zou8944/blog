<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.8.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":false,"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>
<meta name="description" content="说明：文章中代码参考使用方式即可，请忽略其代表的逻辑部分  为何想要用Spring Webflux?《每记》是一款新产品。一开始想用webflux，为什么呢？这里给出自己的几点理由  Spring生态加持，想必会很好用 一直只闻其声不见其人，很想用用 原计划中的vertx-spring项目，想要做成的结果，和webflux很像；因此希望从webflux中找到一些发现  《每记》技术构成《每记》的">
<meta property="og:type" content="article">
<meta property="og:title" content="Spring Webflux初探">
<meta property="og:url" content="http://example.com/2021/03/15/Spring%20Webflux%E5%88%9D%E6%8E%A2-springwebflux-chu-tan/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="说明：文章中代码参考使用方式即可，请忽略其代表的逻辑部分  为何想要用Spring Webflux?《每记》是一款新产品。一开始想用webflux，为什么呢？这里给出自己的几点理由  Spring生态加持，想必会很好用 一直只闻其声不见其人，很想用用 原计划中的vertx-spring项目，想要做成的结果，和webflux很像；因此希望从webflux中找到一些发现  《每记》技术构成《每记》的">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://gdz.oss-cn-shenzhen.aliyuncs.com/halo/tapd_61207716_1615454473_19_1616242796287.png">
<meta property="article:published_time" content="2021-03-15T15:41:04.013Z">
<meta property="article:modified_time" content="2021-03-20T12:24:34.764Z">
<meta property="article:author" content="John Doe">
<meta property="article:tag" content="Webflux">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://gdz.oss-cn-shenzhen.aliyuncs.com/halo/tapd_61207716_1615454473_19_1616242796287.png">


<link rel="canonical" href="http://example.com/2021/03/15/Spring%20Webflux%E5%88%9D%E6%8E%A2-springwebflux-chu-tan/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://example.com/2021/03/15/Spring%20Webflux%E5%88%9D%E6%8E%A2-springwebflux-chu-tan/","path":"2021/03/15/Spring Webflux初探-springwebflux-chu-tan/","title":"Spring Webflux初探"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Spring Webflux初探 | Hexo</title>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Hexo</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%BA%E4%BD%95%E6%83%B3%E8%A6%81%E7%94%A8Spring-Webflux"><span class="nav-number">1.</span> <span class="nav-text">为何想要用Spring Webflux?</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E3%80%8A%E6%AF%8F%E8%AE%B0%E3%80%8B%E6%8A%80%E6%9C%AF%E6%9E%84%E6%88%90"><span class="nav-number">1.1.</span> <span class="nav-text">《每记》技术构成</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Webflux%E7%AE%80%E4%BB%8B"><span class="nav-number">2.</span> <span class="nav-text">Webflux简介</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8"><span class="nav-number">3.</span> <span class="nav-text">使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B7%AF%E7%94%B1"><span class="nav-number">3.1.</span> <span class="nav-text">路由</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%87%E6%BB%A4%E5%99%A8"><span class="nav-number">3.2.</span> <span class="nav-text">过滤器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%85%A8%E5%B1%80%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86"><span class="nav-number">3.3.</span> <span class="nav-text">全局异常处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%90%8C%E6%AD%A5DAO%E7%9A%84%E8%B0%83%E7%94%A8"><span class="nav-number">3.4.</span> <span class="nav-text">同步DAO的调用</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Swagger"><span class="nav-number">3.5.</span> <span class="nav-text">Swagger</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%B5%8B%E8%AF%95"><span class="nav-number">4.</span> <span class="nav-text">测试</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%88%9D%E6%AD%A5%E7%BB%93%E8%AE%BA-%E2%80%94%E2%80%94-%E4%B8%8D%E9%80%89%E6%8B%A9"><span class="nav-number">5.</span> <span class="nav-text">初步结论 —— 不选择</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BC%98%E7%82%B9"><span class="nav-number">5.1.</span> <span class="nav-text">优点</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%BA%E7%82%B9"><span class="nav-number">5.2.</span> <span class="nav-text">缺点</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%B8%8D%E9%80%89%E6%8B%A9%E7%9A%84%E5%8E%9F%E5%9B%A0"><span class="nav-number">6.</span> <span class="nav-text">不选择的原因</span></a></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">John Doe</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">79</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">26</span>
        <span class="site-state-item-name">categories</span>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">42</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/03/15/Spring%20Webflux%E5%88%9D%E6%8E%A2-springwebflux-chu-tan/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Spring Webflux初探
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2021-03-15 23:41:04" itemprop="dateCreated datePublished" datetime="2021-03-15T23:41:04+08:00">2021-03-15</time>
    </span>
      <span class="post-meta-item">
        <span class="post-meta-item-icon">
          <i class="far fa-calendar-check"></i>
        </span>
        <span class="post-meta-item-text">Edited on</span>
        <time title="Modified: 2021-03-20 20:24:34" itemprop="dateModified" datetime="2021-03-20T20:24:34+08:00">2021-03-20</time>
      </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/%E5%93%8D%E5%BA%94%E5%BC%8F-%E5%90%8E%E7%AB%AF/" itemprop="url" rel="index"><span itemprop="name">响应式 | 后端</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <blockquote>
<p>说明：文章中代码参考使用方式即可，请忽略其代表的逻辑部分</p>
</blockquote>
<h2 id="为何想要用Spring-Webflux"><a href="#为何想要用Spring-Webflux" class="headerlink" title="为何想要用Spring Webflux?"></a>为何想要用Spring Webflux?</h2><p>《每记》是一款新产品。一开始想用webflux，为什么呢？这里给出自己的几点理由</p>
<ul>
<li>Spring生态加持，想必会很好用</li>
<li>一直只闻其声不见其人，很想用用</li>
<li>原计划中的vertx-spring项目，想要做成的结果，和webflux很像；因此希望从webflux中找到一些发现</li>
</ul>
<h3 id="《每记》技术构成"><a href="#《每记》技术构成" class="headerlink" title="《每记》技术构成"></a>《每记》技术构成</h3><p>《每记》的主要业务逻辑都在客户端，后端只需要负责用户接口和数据备份。需要用到的技术只有两个</p>
<ul>
<li>grpc —— 用于grpc服务，如user-service，media-service</li>
<li>数据库 —— 用于数据存取</li>
</ul>
<p>grpc的官方库实现基于Netty，天然响应式，能够和webflux结合得比较好；</p>
<p>数据库方面，Spring官方提供R2DBC，但它所处的技术层级和JDBC类似，且尚不成熟，从官方手册的描述就不是很敢用于生产。</p>
<blockquote>
<p>Spring Data R2DBC aims at being conceptually easy. In order to achieve this it does NOT offer caching, lazy loading, write behind or many other features of ORM frameworks. This makes Spring Data R2DBC a simple, limited, opinionated object mapper.</p>
</blockquote>
<p>至于其他的异步数据库链接库，不成体系，使用不便。因此还是使用JDBC。</p>
<p>至于ORM框架，考虑了MyBatis plus、jooq、korm几种，还是认为MyBatis plus相对方便。</p>
<p>于是技术组成就是：</p>
<p>Spring Webflux + GRPC + MyBatis plus</p>
<p>Spring WebMVC + GRPC + Myabtis plus （作为对比）</p>
<h2 id="Webflux简介"><a href="#Webflux简介" class="headerlink" title="Webflux简介"></a>Webflux简介</h2><p>横向看，WebFlux组成大致如下</p>
<p><img src="https://gdz.oss-cn-shenzhen.aliyuncs.com/halo/tapd_61207716_1615454473_19_1616242796287.png" alt="tapd_61207716_1615454473_19"></p>
<p>这和WebMVC的结构图很像，解释一下各部分工作。</p>
<ul>
<li>容器reactor-netty：即基于netty实现的符合reactor标准的容器，Spring Boot默认使用它。其对应的关键核心接口是HttpHandler，webflux中对应的重要实现类是：WebHttpHandlerBuilder，它是整个webflux程序的入口。</li>
<li>Webfilter：过滤器</li>
<li>DispatcherHandler：核心处理器，协调如下三个核心组件工作<ul>
<li>HandleMapping：存储请求URI和处理器的对应关系</li>
<li>HandlerAdapter：封装了主要处理逻辑，处理结果封装成HandlerResult</li>
<li>HandlerResultHandler：针对上一步结果的处理器</li>
</ul>
</li>
<li>WebExceptionHandler：整个流程中抛出的任何异常，都会被它捕获，“真”全局异常处理</li>
</ul>
<p>如想了解进一步内容，请从源码挖掘。</p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><p>本节介绍Webflux的使用方式。Webflux有两种使用方式</p>
<ul>
<li>注解式</li>
<li>编程式</li>
</ul>
<p>我们选择注解式，更为方便。至于API风格，选择kotlin协程。</p>
<p>具体使用方式参见mylog的spring-webflux分支，这里列出几个关键点。</p>
<h3 id="路由"><a href="#路由" class="headerlink" title="路由"></a>路由</h3><p>使用方式和一般的MVC程序没有什么区别，除了一点</p>
<ul>
<li>方法需要是suspend方法或返回Mono/Flux</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResourceController</span></span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> resourceService: ResourceService</span><br><span class="line">) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@PostMapping(<span class="meta-string">&quot;resources/:push&quot;</span>)</span></span><br><span class="line">    <span class="keyword">suspend</span> <span class="function"><span class="keyword">fun</span> <span class="title">push</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="meta">@RequestBody</span> pushRequest: <span class="type">PushRequest</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>: PushResponse &#123;</span><br><span class="line">        <span class="keyword">val</span> result = resourceService.validateAndSave(pushRequest.resources)</span><br><span class="line">        <span class="keyword">return</span> PushResponse(result.map &#123; it.<span class="keyword">data</span> <span class="keyword">as</span> Map&lt;String, Any&gt; &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="过滤器"><a href="#过滤器" class="headerlink" title="过滤器"></a>过滤器</h3><p>Webflux中没有拦截器这个概念，要做类似的工作需要在过滤器中完成，项目中我们用到Token验证，使用方法是注册过滤器。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AuthFilter</span></span>(applicationContext: ApplicationContext) : AbstractAuthFilter(applicationContext) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Value(<span class="meta-string">&quot;\$&#123;authentication.token.name&#125;&quot;</span>)</span></span><br><span class="line">    <span class="keyword">lateinit</span> <span class="keyword">var</span> tokenName: String</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 注意这里使用了协程的grpc stub</span></span><br><span class="line">    <span class="meta">@GrpcClient(<span class="meta-string">&quot;user-service&quot;</span>)</span></span><br><span class="line">    <span class="keyword">lateinit</span> <span class="keyword">var</span> userStub: UsersServiceGrpcKt.UsersServiceCoroutineStub</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">filter</span><span class="params">(exchange: <span class="type">ServerWebExchange</span>, chain: <span class="type">WebFilterChain</span>)</span></span>: Mono&lt;<span class="built_in">Void</span>&gt; = mono &#123;</span><br><span class="line">        <span class="keyword">val</span> request = exchange.request</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (request.needAuth()) &#123;</span><br><span class="line">            <span class="keyword">val</span> token = request.headers[tokenName]?.first() </span><br><span class="line">            <span class="keyword">val</span> result = userStub.verify(Token.newBuilder().setToken(token).build())</span><br><span class="line">            ... ...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// chain.filter返回的是Mono，需要调用await方法转换为协程</span></span><br><span class="line">        chain.filter(exchange).awaitSingleOrNull()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="全局异常处理"><a href="#全局异常处理" class="headerlink" title="全局异常处理"></a>全局异常处理</h3><p>Webflux中可以使用@ControllerAdvice注册全局异常处理器，但它仅Controller中抛出的异常生效，无法顾及到过滤器。对异常，推荐的方式是注册WebExceptionHandler。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Order(Ordered.HIGHEST_PRECEDENCE)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExceptionHandler</span> : <span class="type">ErrorWebExceptionHandler &#123;</span></span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> objectMapper = ObjectMapper()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对协程的支持</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">handle</span><span class="params">(exchange: <span class="type">ServerWebExchange</span>, ex: <span class="type">Throwable</span>)</span></span>: Mono&lt;<span class="built_in">Void</span>&gt; &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> errResponse = objectMapper.writeValueAsBytes(<span class="string">&quot;error message&quot;</span>)</span><br><span class="line"></span><br><span class="line">        response.headers.contentType = MediaType.APPLICATION_PROBLEM_JSON</span><br><span class="line">        response.statusCode = code.httpStatus</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> response.writeWith(Mono.just(response.bufferFactory().wrap(errResponse)))</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="同步DAO的调用"><a href="#同步DAO的调用" class="headerlink" title="同步DAO的调用"></a>同步DAO的调用</h3><p>JDBC是同步的，基于它的MyBatis也是同步的，为了不阻塞DIspatcher-Worker线程，需要将其手动调度到其他线程池。当然如下步骤也可以使用AOP实现，这样就不用为每个方法手动调mono方法。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 注入Scheduler</span></span><br><span class="line"><span class="meta">@Autowired</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> scheduler: Scheduler</span><br><span class="line"><span class="comment">// 讲同步代码注册到该scheduler</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> <span class="title">mono</span><span class="params">(block: () -&gt; <span class="type">T</span>)</span></span>: Mono&lt;T&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> Mono.defer &#123; Mono.just(block()) &#125;.subscribeOn(scheduler)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用方式</span></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">save</span><span class="params">(modifications: <span class="type">List</span>&lt;<span class="type">Resource</span>&gt;)</span></span>: Mono&lt;List&lt;Resource&gt;&gt; = mono &#123;</span><br><span class="line">    modifications.mapNotNull &#123;</span><br><span class="line">        resourceMapper.save(it)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Swagger"><a href="#Swagger" class="headerlink" title="Swagger"></a>Swagger</h3><p>Knife4j的增强功能无法在Webflux下使用，且当controller为suspend方法时无法正常读取到返回值，需要打如下补丁。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *  修复controller方法为suspend方法时，springfox无法获取返回值类型的情况</span></span><br><span class="line"><span class="comment"> *  因为suspend方法转换为字节码后返回值为null</span></span><br><span class="line"><span class="comment"> *  #issue: https://github.com/springfox/springfox/issues/3241</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="meta">@Primary</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CustomRequestHandler</span></span>(</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> resolver: TypeResolver</span><br><span class="line">) : HandlerMethodResolver(resolver) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">methodReturnType</span><span class="params">(handlerMethod: <span class="type">HandlerMethod</span>)</span></span>: ResolvedType &#123;</span><br><span class="line">        <span class="keyword">val</span> func = handlerMethod.beanType.kotlin.declaredFunctions.first &#123; it.javaMethod == handlerMethod.method &#125;</span><br><span class="line">        <span class="keyword">if</span> (func.returnType == <span class="built_in">Unit</span>::<span class="keyword">class</span>.starProjectedType) resolver.resolve(<span class="built_in">Void</span>.TYPE)</span><br><span class="line">        <span class="keyword">return</span> resolver.resolve(func.returnType.javaType)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h2><p>以一个最典型的接口resources/:pull进行压力测试，该接口逻辑如下</p>
<ul>
<li>访问user-service验证token</li>
<li>访问数据库读取数据</li>
</ul>
<p>测试工具为apache-utils，ab。</p>
<p>测试结果总结就是：相同条件下，webflux的性能表现相比webmvc并没有什么变化。</p>
<h2 id="初步结论-——-不选择"><a href="#初步结论-——-不选择" class="headerlink" title="初步结论 —— 不选择"></a>初步结论 —— 不选择</h2><h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><ul>
<li>本身的异步模型</li>
<li>Spring生态支持，依赖注入，注解，协程</li>
</ul>
<h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><ul>
<li>整体生态的缺乏，首要的是异步ORM</li>
<li>响应式的固有问题，学习曲线</li>
</ul>
<h2 id="不选择的原因"><a href="#不选择的原因" class="headerlink" title="不选择的原因"></a>不选择的原因</h2><ul>
<li>实际测试下来，性能并没有实质性的提升，反而增加了开发难度<ul>
<li>需要桥接阻塞的ORM库存</li>
<li>Springfox打补丁</li>
<li>没有拦截器，只有过滤器，做权限验证时不方便</li>
<li>其它未知的点</li>
</ul>
</li>
<li>上手成本，从近期招聘简历上看，熟悉响应式的人少之又少，我们有极大可能招聘到一个对此不熟悉的人，技术墙还是有的。</li>
</ul>
<p>综上，如果引入webflux，并没有带来好处，反而有诸多不便。因此最终决定使用webmvc。</p>

    </div>

    
    
    

    <footer class="post-footer">
          <div class="post-tags">
              <a href="/tags/Webflux/" rel="tag"># Webflux</a>
          </div>

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/02/08/%E9%A6%92-%E9%A6%92%E5%A4%B4%E7%9A%84%E8%87%AA%E6%88%91%E4%BF%AE%E7%82%BC/" rel="prev" title="馒">
                  <i class="fa fa-chevron-left"></i> 馒
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/07/01/%E5%A6%82%E4%BD%95%E5%BA%94%E5%AF%B9%E6%97%A0%E6%84%8F%E4%B9%89%E6%84%9F-ru-he-ying-dui-wu-yi-yi-gan/" rel="next" title="如何应对无意义感">
                  如何应对无意义感 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  





  





</body>
</html>
